# I2S硬件测试程序使用指南

## 📋 概述

提供两个测试程序来验证 INMP441 麦克风和 MAX98357 功放的硬件连接：

1. **`i2s_hardware_test.py`** - 完整版测试程序
2. **`simple_loopback_test.py`** - 简化版测试程序

## 🔌 硬件连接

### INMP441 麦克风连接
```
INMP441    ESP32-S3
SCK    →   GPIO 5
WS     →   GPIO 4  
SD     →   GPIO 6
VDD    →   3.3V
GND    →   GND
```

### MAX98357 功放连接
```
MAX98357   ESP32-S3
BCLK   →   GPIO 15
LRC    →   GPIO 16
DIN    →   GPIO 7
VIN    →   5V
GND    →   GND
```

## 🚀 使用方法

### 1. 简化版测试 (推荐)

```python
# 在 MicroPython REPL 中运行
exec(open('simple_loopback_test.py').read())
```

**功能**:
- 录音 2 秒 → 播放录音 → 循环
- 显示音频能量检测
- 自动循环测试

**预期输出**:
```
🔧 简化版I2S硬件测试
==============================
🎙️ 初始化麦克风...
✅ 麦克风初始化成功
🔊 初始化功放...
✅ 功放初始化成功

🔄 第 1 轮测试
🎤 录音 2 秒，请说话...
✅ 录音完成: 64000字节, 2050ms
🎵 音频能量: 245
🔊 播放录制的音频...
✅ 播放完成: 64000字节, 2100ms
⏳ 等待2秒后继续...
```

### 2. 完整版测试

```python
# 运行完整测试程序
exec(open('i2s_hardware_test.py').read())
```

**功能**:
- 详细的硬件连接检查
- 音频质量评估
- 成功率统计
- 错误处理和重试

### 3. 麦克风专项测试

```python
# 只测试麦克风
from simple_loopback_test import run_mic_only_test
run_mic_only_test()
```

## 📊 测试结果判断

### 音频能量参考值
| 能量范围 | 质量评级 | 说明 |
|----------|----------|------|
| > 500    | 优秀     | 麦克风工作良好，音频清晰 |
| 200-500  | 良好     | 麦克风正常，音质可接受 |
| 50-200   | 一般     | 麦克风信号弱，检查连接 |
| < 50     | 较弱     | 麦克风可能未连接或故障 |

### 成功的测试表现
✅ **正常情况**:
```
🎵 音频能量: 325 (质量: 良好)
✅ 录音完成: 64000字节, 2050ms
✅ 播放完成: 64000字节, 2100ms
✅ 本次测试循环成功!
```

❌ **异常情况**:
```
🎵 音频能量: 12 (质量: 较弱)
⚠️ 音频信号很弱，请检查麦克风连接和音量
⚠️ 本次测试循环存在问题
```

## 🔧 故障排除

### 1. 麦克风无声音 (能量 < 50)
**可能原因**:
- 麦克风引脚连接错误
- 麦克风电源未连接 (3.3V)
- 麦克风损坏

**检查步骤**:
1. 确认引脚连接：SCK=5, WS=4, SD=6
2. 检查电源连接：VDD → 3.3V, GND → GND
3. 测试时对着麦克风说话或制造声音

### 2. 播放无声音
**可能原因**:
- 功放引脚连接错误
- 功放电源不足 (需要5V)
- 扬声器未连接

**检查步骤**:
1. 确认引脚连接：BCLK=15, LRC=16, DIN=7
2. 检查电源：VIN → 5V (不是3.3V)
3. 连接扬声器到功放输出端

### 3. I2S 初始化失败
**错误信息**: `❌ I2S设备初始化失败`

**解决方案**:
1. 重启开发板
2. 确认引脚未被其他程序占用
3. 检查固件是否支持 I2S

### 4. 内存不足
**错误信息**: `MemoryError: memory allocation failed`

**解决方案**:
1. 重启 MicroPython
2. 减少录音时长 (修改 `RECORD_DURATION`)
3. 手动调用 `gc.collect()` 清理内存

## 🎯 测试建议

### 快速验证流程
1. **运行简化版测试** → 验证基本功能
2. **观察音频能量** → 确认麦克风工作
3. **听取播放音频** → 确认功放工作
4. **运行几个循环** → 验证稳定性

### 深度测试流程
1. **运行完整版测试** → 详细评估
2. **查看成功率统计** → 评估稳定性
3. **长时间运行** → 验证可靠性

## 📝 自定义配置

可以修改测试参数：

```python
# 在程序中修改这些参数
SAMPLE_RATE = 16000    # 采样率
BITS = 16              # 位深度  
RECORD_DURATION = 2    # 录音时长(秒)
BUFFER_LENGTH = 1024   # 缓冲区大小
```

## 💡 注意事项

1. **I2S 冲突**: 如果运行 ESP-SR 后再运行此测试，可能出现 I2S 冲突，需要重启
2. **内存管理**: 长时间运行建议定期重启以清理内存
3. **硬件检查**: 测试前务必确认硬件连接正确
4. **音量调节**: MAX98357 有硬件增益设置，可调节 GAIN 引脚 