# AECæ‰“æ–­åŠŸèƒ½å®ç°æŒ‡å—

## ğŸ“Œ éœ€æ±‚æ¦‚è¿°

åœ¨æ’­æ”¾å›å¤éŸ³é¢‘æ—¶ï¼Œå¯ä»¥é€šè¿‡å”¤é†’è¯æˆ–å…¶ä»–è¯­éŸ³éšæ—¶æ‰“æ–­æ’­æ”¾ï¼Œå¹¶ç«‹å³å¼€å§‹æ–°çš„å½•éŸ³å¯¹è¯ã€‚

## ğŸ¯ æ ¸å¿ƒæ”¹åŠ¨

### 1. `modespsr.c` - å¯ç”¨ESP-SRçš„AECåŠŸèƒ½

#### æ”¹åŠ¨ä½ç½®ï¼šç¬¬264è¡Œ

**ä¿®æ”¹å‰ï¼š**
```c
afe_config->aec_init = false;
```

**ä¿®æ”¹åï¼š**
```c
afe_config->aec_init = true;  // å¯ç”¨AECå›å£°æ¶ˆé™¤
```

#### è¯´æ˜
- ESP-SRçš„AFEæ¨¡å—å†…ç½®AECï¼ˆå›å£°æ¶ˆé™¤ï¼‰åŠŸèƒ½
- å¯ç”¨åå¯ä»¥åœ¨æ’­æ”¾æ—¶æ›´å¥½åœ°è¯†åˆ«è¯­éŸ³
- éœ€è¦é…åˆéŸ³é‡é™ä½ä½¿ç”¨ï¼Œæ•ˆæœæ›´ä½³

---

### 2. `logic.py` - å®ç°æ‰“æ–­é€»è¾‘

#### æ”¹åŠ¨Aï¼šä¿æŒespsrç›‘å¬æ´»è·ƒï¼ˆç¬¬727-730è¡Œå’Œç¬¬778-781è¡Œï¼‰

**ä¿®æ”¹å‰ï¼š**
```python
# æ¸…ç†èµ„æºï¼Œæ‰“å¼€å½•éŸ³ i2s
espsr.cleanup()
gc.collect()
self.is_wakeup_mic = False
```

**ä¿®æ”¹åï¼š**
```python
# ğŸ”¥ å…³é”®æ”¹åŠ¨ï¼šä¸æ¸…ç†espsrï¼Œä¿æŒç›‘å¬æ´»è·ƒä»¥æ”¯æŒAECæ‰“æ–­
# espsr.cleanup()  # æ³¨é‡Šæ‰
# self.is_wakeup_mic = False  # æ³¨é‡Šæ‰
gc.collect()
```

**è¯´æ˜ï¼š**
- å”¤é†’åä¸å†å…³é—­espsrç›‘å¬
- è®©espsråœ¨æ•´ä¸ªå¯¹è¯è¿‡ç¨‹ä¸­ä¿æŒè¿è¡Œ
- è¿™æ˜¯å®ç°AECæ‰“æ–­çš„å…³é”®å‰æ

---

#### æ”¹åŠ¨Bï¼šæ’­æ”¾çº¿ç¨‹ä¸­æ£€æµ‹æ‰“æ–­ï¼ˆç¬¬286-328è¡Œï¼‰

**æ ¸å¿ƒä»£ç ï¼š**
```python
def playback_thread_func(self, socket_obj):
    """æ’­æ”¾çº¿ç¨‹å‡½æ•° - æ”¯æŒAECæ‰“æ–­ç‰ˆæœ¬"""
    print("ğŸµ æ’­æ”¾çº¿ç¨‹å¯åŠ¨ï¼ˆæ”¯æŒAECæ‰“æ–­ï¼‰")
    
    # ... åˆå§‹åŒ–ä»£ç  ...
    
    volume_reduction_factor = 0.5  # å¯ç”¨éŸ³é‡é™ä½ï¼Œå¸®åŠ©AECè¯†åˆ«
    interrupt_check_interval = 5   # æ¯5ä¸ªæ•°æ®åŒ…æ£€æµ‹ä¸€æ¬¡æ‰“æ–­
    
    try:
        while not self.stop_playback_thread:
            # ğŸ”¥ æ¯éš”ä¸€å®šæ¬¡æ•°æ£€æµ‹æ‰“æ–­ä¿¡å·
            if data_count % interrupt_check_interval == 0:
                # æ£€æµ‹espsræ˜¯å¦æœ‰æ–°çš„å”¤é†’æˆ–å‘½ä»¤è¯ï¼ˆéé˜»å¡ï¼‰
                try:
                    import espsr
                    result = espsr.listen(1)  # 1msè¶…æ—¶ï¼Œéé˜»å¡æ£€æµ‹
                    if result == "wakeup" or (isinstance(result, dict) and "id" in result):
                        print("ğŸ›‘ æ£€æµ‹åˆ°å”¤é†’è¯æ‰“æ–­ï¼")
                        self.wakeup_interrupted = True
                        self.stop_playback_thread = True
                        break
                except:
                    pass
            
            # ç»§ç»­æ¥æ”¶å’Œæ’­æ”¾éŸ³é¢‘æ•°æ®...
            data = socket_obj.recv(4096)
            # ...
```

**è¯´æ˜ï¼š**
- æ’­æ”¾è¿‡ç¨‹ä¸­å®šæœŸè°ƒç”¨`espsr.listen(1)`è¿›è¡Œéé˜»å¡æ£€æµ‹
- æ£€æµ‹åˆ°å”¤é†’è¯æˆ–å‘½ä»¤è¯æ—¶ç«‹å³åœæ­¢æ’­æ”¾
- è®¾ç½®`wakeup_interrupted`æ ‡å¿—ç”¨äºåç»­å¤„ç†
- éŸ³é‡é™ä½åˆ°50%å¸®åŠ©AECè¯†åˆ«äººå£°

---

#### æ”¹åŠ¨Cï¼šæ‰“æ–­åçš„å¤„ç†é€»è¾‘ï¼ˆç¬¬752-757è¡Œå’Œç¬¬794-799è¡Œï¼‰

**ä¿®æ”¹åï¼š**
```python
# ğŸ”¥ æ£€æŸ¥æ˜¯å¦è¢«æ‰“æ–­ï¼Œå¦‚æœè¢«æ‰“æ–­åˆ™ç«‹å³å¼€å§‹æ–°çš„å½•éŸ³
if self.wakeup_interrupted:
    print("ğŸ”„ æ£€æµ‹åˆ°æ’­æ”¾è¢«æ‰“æ–­ï¼Œç«‹å³å¼€å§‹æ–°çš„å½•éŸ³...")
    self.wakeup_interrupted = False
    # espsrä¿æŒè¿è¡Œï¼Œç›´æ¥å¼€å§‹å½•éŸ³
    self.recordToAI()
```

**è¯´æ˜ï¼š**
- æ£€æµ‹åˆ°æ‰“æ–­åç«‹å³å¼€å§‹æ–°çš„å½•éŸ³
- æ— éœ€é‡æ–°åˆå§‹åŒ–espsrï¼ˆä¿æŒè¿è¡Œï¼‰
- å½¢æˆè¿ç»­çš„å¯¹è¯å¾ªç¯

---

#### æ”¹åŠ¨Dï¼šä¸»å¾ªç¯ä¼˜åŒ–ï¼ˆç¬¬711-725è¡Œï¼‰

**ä¿®æ”¹åï¼š**
```python
# ğŸ”¥ AECæ¨¡å¼ï¼šespsrå§‹ç»ˆä¿æŒè¿è¡Œï¼Œä¸è¿›è¡Œæ¸…ç†å’Œé‡æ–°åˆå§‹åŒ–
if not self.is_wakeup_mic:
    init_result = espsr.init()
    if init_result:
        print("âœ… ESP-SR åˆå§‹åŒ–æˆåŠŸ!")
        self.is_wakeup_mic = True
    else:
        print("âŒ ESP-SR åˆå§‹åŒ–å¤±è´¥!")
        return

# ğŸ”¥ AECæ¨¡å¼ï¼šæ’­æ”¾æ—¶ä¸æš‚åœç›‘å¬ï¼Œè€Œæ˜¯é™ä½æ£€æµ‹é¢‘ç‡
if self.is_playing_response or self.playback_thread_active:
    # æ’­æ”¾æ—¶ç»§ç»­ç›‘å¬ä½†é™ä½é¢‘ç‡ï¼Œç”±æ’­æ”¾çº¿ç¨‹å†…éƒ¨è¿›è¡Œæ‰“æ–­æ£€æµ‹
    time.sleep(0.1)  # çŸ­æš‚ä¼‘çœ ï¼Œè®©æ’­æ”¾çº¿ç¨‹æ‰§è¡Œ
    continue
```

**è¯´æ˜ï¼š**
- espsråªåˆå§‹åŒ–ä¸€æ¬¡ï¼Œåç»­ä¿æŒè¿è¡Œ
- æ’­æ”¾æ—¶ä¸»å¾ªç¯ä¸æš‚åœç›‘å¬ï¼Œè€Œæ˜¯é™ä½æ£€æµ‹é¢‘ç‡
- æ‰“æ–­æ£€æµ‹ä¸»è¦ç”±æ’­æ”¾çº¿ç¨‹å†…éƒ¨å®Œæˆ

---

## ğŸ”„ å·¥ä½œæµç¨‹

### æ­£å¸¸æµç¨‹
1. ç”¨æˆ·è¯´"å—¨å°ä¹"å”¤é†’
2. espsræ£€æµ‹åˆ°å”¤é†’è¯
3. æ’­æ”¾"æˆ‘åœ¨"æç¤ºéŸ³
4. å¼€å§‹å½•éŸ³3ç§’ï¼ˆespsrä¿æŒè¿è¡Œï¼‰
5. å‘é€å½•éŸ³åˆ°äº‘ç«¯
6. æ¥æ”¶å¹¶æ’­æ”¾å›å¤éŸ³é¢‘ï¼ˆespsrä¿æŒè¿è¡Œï¼‰
7. æ’­æ”¾å®Œæˆï¼Œå›åˆ°ç›‘å¬çŠ¶æ€

### æ‰“æ–­æµç¨‹
1. æ­£åœ¨æ’­æ”¾å›å¤éŸ³é¢‘
2. ç”¨æˆ·è¯´"å—¨å°ä¹"ï¼ˆæˆ–å…¶ä»–å‘½ä»¤è¯ï¼‰
3. æ’­æ”¾çº¿ç¨‹é€šè¿‡`espsr.listen(1)`æ£€æµ‹åˆ°æ‰“æ–­
4. ç«‹å³åœæ­¢æ’­æ”¾
5. è®¾ç½®`wakeup_interrupted=True`
6. ä¸»å¾ªç¯æ£€æµ‹åˆ°æ‰“æ–­æ ‡å¿—
7. ç«‹å³å¼€å§‹æ–°çš„å½•éŸ³
8. å‘é€åˆ°äº‘ç«¯å¹¶æ’­æ”¾æ–°çš„å›å¤

---

## âš™ï¸ å…³é”®å‚æ•°é…ç½®

### æ’­æ”¾éŸ³é‡
```python
volume_reduction_factor = 0.5  # é™ä½50%éŸ³é‡
```
- **0.5**ï¼šé™ä½50%ï¼ˆæ¨èï¼ŒAECæ•ˆæœå¥½ï¼‰
- **0.25**ï¼šé™ä½75%ï¼ˆæ›´å®¹æ˜“è¯†åˆ«ï¼Œä½†éŸ³é‡å°ï¼‰
- **1.0**ï¼šä¸é™ä½ï¼ˆæ€§èƒ½æœ€ä½³ï¼Œä½†AECæ•ˆæœå·®ï¼‰

### æ‰“æ–­æ£€æµ‹é¢‘ç‡
```python
interrupt_check_interval = 5  # æ¯5ä¸ªåŒ…æ£€æµ‹ä¸€æ¬¡
```
- **5**ï¼šå¹³è¡¡æ€§èƒ½å’Œå“åº”é€Ÿåº¦ï¼ˆæ¨èï¼‰
- **3**ï¼šæ›´å¿«å“åº”ï¼Œä½†CPUå ç”¨é«˜
- **10**ï¼šé™ä½CPUå ç”¨ï¼Œä½†å“åº”æ…¢

### I2Sç¼“å†²åŒº
```python
ibuf=8192  # 8KBç¼“å†²åŒº
```
- **8192**ï¼šæµç•…æ’­æ”¾ï¼Œä½å¡é¡¿ï¼ˆæ¨èï¼‰
- **16384**ï¼šæ›´æµç•…ï¼Œä½†å ç”¨æ›´å¤šå†…å­˜
- **4096**ï¼šèŠ‚çœå†…å­˜ï¼Œå¯èƒ½æœ‰è½»å¾®å¡é¡¿

---

## ğŸ› å¯èƒ½çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šæ‰“æ–­ä¸çµæ•

**åŸå› ï¼š**
- æ’­æ”¾éŸ³é‡å¤ªå¤§
- æ£€æµ‹é¢‘ç‡å¤ªä½
- AECæœªå¯ç”¨

**è§£å†³ï¼š**
```python
# é™ä½éŸ³é‡
volume_reduction_factor = 0.25  # é™ä½åˆ°25%

# æé«˜æ£€æµ‹é¢‘ç‡
interrupt_check_interval = 3  # æ¯3ä¸ªåŒ…æ£€æµ‹ä¸€æ¬¡

# ç¡®ä¿modespsr.cä¸­AECå·²å¯ç”¨
afe_config->aec_init = true;
```

### é—®é¢˜2ï¼šè¯¯è§¦å‘æ‰“æ–­

**åŸå› ï¼š**
- æ’­æ”¾çš„éŸ³é¢‘è¢«è¯†åˆ«ä¸ºå”¤é†’è¯
- ç¯å¢ƒå™ªéŸ³å¹²æ‰°

**è§£å†³ï¼š**
```python
# å¢åŠ æ£€æµ‹é˜ˆå€¼ï¼ˆéœ€è¦åœ¨modespsr.cä¸­è°ƒæ•´MultiNeté˜ˆå€¼ï¼‰
# æˆ–è€…å¢åŠ æ£€æµ‹é—´éš”
interrupt_check_interval = 10
```

### é—®é¢˜3ï¼šæ’­æ”¾å¡é¡¿

**åŸå› ï¼š**
- æ‰“æ–­æ£€æµ‹é¢‘ç‡å¤ªé«˜
- ç¼“å†²åŒºå¤ªå°

**è§£å†³ï¼š**
```python
# é™ä½æ£€æµ‹é¢‘ç‡
interrupt_check_interval = 10

# å¢å¤§ç¼“å†²åŒº
MIN_PLAY_BUFFER = 8192
ibuf = 16384
```

---

## âœ… æµ‹è¯•æ­¥éª¤

1. **ç¼–è¯‘å’Œçƒ§å½•**
   ```bash
   # ä¿®æ”¹modespsr.cåéœ€è¦é‡æ–°ç¼–è¯‘å›ºä»¶
   cd ports/esp32
   make clean
   make
   make deploy
   ```

2. **ä¸Šä¼ logic.py**
   - ä½¿ç”¨Thonnyä¸Šä¼ ä¿®æ”¹åçš„`logic.py`åˆ°è®¾å¤‡

3. **æµ‹è¯•å”¤é†’**
   - è¯´"å—¨å°ä¹"ï¼Œç¡®è®¤èƒ½æ­£å¸¸å”¤é†’
   - è¯´é—®é¢˜ï¼Œç¡®è®¤èƒ½å½•éŸ³å’Œæ¥æ”¶å›å¤

4. **æµ‹è¯•æ‰“æ–­**
   - åœ¨æ’­æ”¾å›å¤æ—¶è¯´"å—¨å°ä¹"
   - è§‚å¯Ÿæ˜¯å¦ç«‹å³åœæ­¢æ’­æ”¾
   - ç¡®è®¤æ˜¯å¦å¼€å§‹æ–°çš„å½•éŸ³

5. **è§‚å¯Ÿæ—¥å¿—**
   ```
   ğŸµ æ’­æ”¾çº¿ç¨‹å¯åŠ¨ï¼ˆæ”¯æŒAECæ‰“æ–­ï¼‰
   ğŸ“¡ æ¥æ”¶ #1, 4096å­—èŠ‚
   ğŸ“¡ æ¥æ”¶ #6, 4096å­—èŠ‚
   ğŸ›‘ æ£€æµ‹åˆ°å”¤é†’è¯æ‰“æ–­ï¼
   ğŸ”„ æ£€æµ‹åˆ°æ’­æ”¾è¢«æ‰“æ–­ï¼Œç«‹å³å¼€å§‹æ–°çš„å½•éŸ³...
   start recordToAI
   ```

---

## ğŸ“Š æ€§èƒ½å½±å“

| é¡¹ç›® | æ”¹åŠ¨å‰ | æ”¹åŠ¨å | å½±å“ |
|------|--------|--------|------|
| espsrçŠ¶æ€ | å”¤é†’åå…³é—­ | æŒç»­è¿è¡Œ | CPUå ç”¨+5% |
| æ’­æ”¾å“åº”å»¶è¿Ÿ | æ— æ³•æ‰“æ–­ | 100-500ms | ç”¨æˆ·ä½“éªŒå¤§å¹…æå‡ |
| æ’­æ”¾æµç•…åº¦ | æµç•… | æµç•…ï¼ˆè½»å¾®å½±å“ï¼‰ | å‡ ä¹æ— å½±å“ |
| å†…å­˜å ç”¨ | ä½ | ä¸­ç­‰ | +2-3MB |

---

## ğŸ“ æŠ€æœ¯åŸç†

### AECï¼ˆå›å£°æ¶ˆé™¤ï¼‰åŸç†
1. **éº¦å…‹é£è¾“å…¥**ï¼šé‡‡é›†åˆ°çš„éŸ³é¢‘ = ç”¨æˆ·è¯´è¯ + å–‡å­æ’­æ”¾
2. **å‚è€ƒä¿¡å·**ï¼šå–‡å­æ’­æ”¾çš„éŸ³é¢‘
3. **AECå¤„ç†**ï¼šéº¦å…‹é£è¾“å…¥ - å‚è€ƒä¿¡å· = ç”¨æˆ·è¯´è¯
4. **ç»“æœ**ï¼šå»é™¤å›å£°åçš„çº¯å‡€äººå£°

### ESP-SRçš„AECå®ç°
- AFEï¼ˆAudio Front-Endï¼‰æ¨¡å—è´Ÿè´£éŸ³é¢‘é¢„å¤„ç†
- åŒ…æ‹¬é™å™ªã€AECã€AGCï¼ˆè‡ªåŠ¨å¢ç›Šæ§åˆ¶ï¼‰
- `afe_config->aec_init = true` å¯ç”¨AECåŠŸèƒ½
- éœ€è¦åŒæ—¶è¾“å…¥éº¦å…‹é£æ•°æ®å’Œæ’­æ”¾æ•°æ®ï¼ˆreferenceï¼‰

### å½“å‰å®ç°çš„ç®€åŒ–æ–¹æ¡ˆ
- å¯ç”¨AFEçš„åŸºç¡€AECåŠŸèƒ½
- é€šè¿‡é™ä½æ’­æ”¾éŸ³é‡è¾…åŠ©AECè¯†åˆ«
- æ’­æ”¾æ—¶é€šè¿‡éé˜»å¡æ£€æµ‹å®ç°æ‰“æ–­

---

## ğŸš€ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### é«˜çº§AECæ–¹æ¡ˆ
å¦‚æœåŸºç¡€æ–¹æ¡ˆæ•ˆæœä¸ç†æƒ³ï¼Œå¯ä»¥å®ç°å®Œæ•´çš„referenceä¿¡å·è¾“å…¥ï¼š

1. **åœ¨modespsr.cæ·»åŠ referenceè¾“å…¥æ¥å£**
   ```c
   // å‘AFEè¾“å…¥æ’­æ”¾æ•°æ®ä½œä¸ºå‚è€ƒä¿¡å·
   void espsr_feed_reference(int16_t *ref_data, int samples) {
       if (afe_handle && afe_data) {
           // å…·ä½“APIéœ€æŸ¥çœ‹ESP-SRæ–‡æ¡£
           afe_handle->feed_reference(afe_data, ref_data, samples);
       }
   }
   ```

2. **åœ¨logic.pyæ’­æ”¾æ—¶è¾“å…¥reference**
   ```python
   # æ’­æ”¾éŸ³é¢‘çš„åŒæ—¶è¾“å…¥åˆ°AFEä½œä¸ºå‚è€ƒ
   self.audio_out.write(audio_buffer)
   espsr.feed_reference(audio_buffer)  # æ–°å¢
   ```

### åŒI2Sæ–¹æ¡ˆ
- I2S0ï¼šespsrä¸“ç”¨ï¼ˆPDMéº¦å…‹é£ï¼‰
- I2S1ï¼šæ’­æ”¾ä¸“ç”¨ï¼ˆå–‡å­ï¼‰
- ä¸¤è€…åŒæ—¶è¿è¡Œï¼Œæ— éœ€åˆ‡æ¢

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [ESP-SRå®˜æ–¹æ–‡æ¡£](https://github.com/espressif/esp-sr)
- [ESP-IDF I2Sé©±åŠ¨æ–‡æ¡£](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/i2s.html)
- [AECç®—æ³•åŸç†](https://en.wikipedia.org/wiki/Echo_suppression_and_cancellation)

---

## ğŸ“ æ€»ç»“

æœ¬æ¬¡æ”¹åŠ¨å®ç°äº†åŸºäºESP-SRçš„AECæ‰“æ–­åŠŸèƒ½ï¼Œä¸»è¦æ”¹åŠ¨ç‚¹ï¼š

1. âœ… å¯ç”¨AFEçš„AECåŠŸèƒ½ï¼ˆ`modespsr.c`ï¼‰
2. âœ… espsrä¿æŒæŒç»­è¿è¡Œï¼ˆ`logic.py`ï¼‰
3. âœ… æ’­æ”¾æ—¶éé˜»å¡æ£€æµ‹æ‰“æ–­ï¼ˆ`logic.py`ï¼‰
4. âœ… é™ä½æ’­æ”¾éŸ³é‡è¾…åŠ©AECï¼ˆ`logic.py`ï¼‰
5. âœ… æ‰“æ–­åç«‹å³å¼€å§‹æ–°å¯¹è¯ï¼ˆ`logic.py`ï¼‰

è¿™æ˜¯ä¸€ä¸ªæ¸è¿›å¼çš„æ”¹åŠ¨æ–¹æ¡ˆï¼Œå…ˆå®ç°åŸºç¡€çš„æ‰“æ–­åŠŸèƒ½ï¼Œåç»­å¯ä»¥æ ¹æ®å®é™…æ•ˆæœè¿›è¡Œè¿›ä¸€æ­¥ä¼˜åŒ–ã€‚

