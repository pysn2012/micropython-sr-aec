# v2.4 修改总结 - VOIP模式 + 移除无效预热

## 📅 日期
2025-10-27

---

## ✅ 本次修改

### 1. 切换到 VOIP AEC 模式

**文件**: `modespsr.c`

**修改内容**:
```c
// 第 457 行
afe_config->aec_mode = AEC_MODE_VOIP_HIGH_PERF;  // 从 AEC_MODE_SR_HIGH_PERF 改为 VOIP 模式
```

**原因**:
- 参考项目使用 `AEC_MODE_VOIP_HIGH_PERF`
- VOIP 模式的 AEC 强度更强，更适合持续对话场景
- SR 模式设计用于短暂唤醒，AEC 能力较弱

### 2. 降噪（NS）配置已添加

**文件**: `modespsr.c`

**内容**（已在 v2.3 添加）:
```c
// 第 444-468 行
char *ns_model_name = esp_srmodel_filter(models, ESP_NSNET_PREFIX, NULL);

if (ns_model_name != NULL) {
    afe_config->ns_init = true;
    afe_config->ns_model_name = ns_model_name;
    afe_config->afe_ns_mode = AFE_NS_MODE_NET;
}
```

**注意**:
- 如果降噪模型文件不存在，会自动禁用
- 需要在编译日志中确认 `NS model found` 或 `NS model not found`

### 3. 移除 AEC 预热机制

**文件**: `test_logic.py`

**移除的代码**:
```python
# 已删除:
# aec_warmup_chunks = 10
# if data_count >= aec_warmup_chunks:
#     is_speaking = espsr.check_vad()
```

**现在的代码**（第 203-210 行）:
```python
# 直接检测 VAD，无预热延迟
is_speaking = espsr.check_vad()
if is_speaking:
    # 打断
    break
```

**原因**:
- 用户反馈：预热机制没有意义，过了10个块后还是会被打断
- 根本原因是 AEC 本身未正确工作，预热只是掩盖问题
- 如果 AEC 正确配置，应该无需预热

---

## 🔍 测试重点

### 关键检查项

编译后查看日志，确认：

1. **AEC 模式**:
```
AFE config: format=MR, aec_init=true, aec_mode=2, ...
                                               ↑ 必须是 2 (VOIP模式)
```

2. **降噪状态**:
```
NS model found: nsnet1_quantized  ← 最好有
NS enabled with model: nsnet1_quantized
```
或
```
NS model not found, noise suppression will be disabled  ← 可接受，先测试 AEC
```

3. **双通道验证**:
```
AFE feed channels: 2 (expected: 2 for MR)  ← 必须是 2
```

### 测试期望

**如果 AEC 工作正常**:
```
📡 播放进度: 2.3% (4096/179042)
📡 播放进度: 23.6% (45056/179042)
📡 播放进度: 44.9% (86016/179042)
...
✅ 播放线程正常结束  ← 完整播放，无自我打断
```

**如果 AEC 仍失效**:
```
📡 播放进度: 2.3% (4096/179042)
🗣️ 检测到语音活动打断！（VAD）  ← 立即被自己打断
```

---

## 📂 修改文件清单

### 需要上传的文件

1. **C 代码**:
   - ✅ `ports/esp32/modespsr.c` - AEC 模式改为 VOIP

2. **Python 代码**:
   - ✅ `ports/esp32/modules/test_logic.py` - 移除预热机制

3. **文档**:
   - ✅ `ports/esp32/AEC_VOIP模式和诊断指南.md` - 新增诊断指南
   - ✅ `ports/esp32/v2.4修改总结.md` - 本文件
   - ✅ `README.md` - 更新文档索引

### 无需删除的文件

- `ports/esp32/AEC完整配置和降噪修复说明.md` - v2.3 文档保留作为参考

---

## 🚀 编译和测试

### 1. 编译固件

```bash
cd /Users/renzhaojing/gitcode/renhejia/micropython-sr-aec/ports/esp32
idf.py build flash monitor
```

### 2. 观察初始化日志

**必须确认的日志**:
```
I (xxxx) espsr: Initializing ESP-SR with AEC...
I (xxxx) espsr: NS model found: nsnet1_quantized  (或 NS model not found)
I (xxxx) espsr: AFE config: format=MR, aec_init=true, aec_mode=2, ns_init=..., vad_init=true
I (xxxx) espsr: AFE feed channels: 2 (expected: 2 for MR)
```

### 3. 运行测试

```python
import test_logic
sensor = test_logic.SensorSystem()
sensor.run()
```

### 4. 分析结果

**场景 A - 完全成功**:
- 播放完整音频（约 6 秒）
- 期间无自我打断
- 真实说话能正确触发打断

**场景 B - 部分成功**:
- 播放 1-2 秒后被自己打断
- 说明 AEC 有一定效果但不够强

**场景 C - 完全失败**:
- 播放立即被自己打断
- 说明 AEC 基本无效

---

## 🔧 如果仍然失败

### 诊断步骤

1. **检查降噪模型**:
   - 如果 `NS model not found`，可能影响 AEC 效果
   - 检查 ESP-SR 组件是否包含降噪模型文件

2. **验证参考信号**:
   - 在 `feed_Task` 中添加调试日志
   - 确认 `g_last_reference_time_us` 被正确更新
   - 确认参考信号缓冲区有非零数据

3. **对比参考项目**:
   - 查看参考项目的完整 `afe_config` 配置
   - 可能有其他未发现的关键参数

4. **临时禁用 VAD**:
   - 注释掉 `espsr.check_vad()` 检测
   - 只用唤醒词打断
   - 测试播放本身是否流畅

### 详细诊断指南

请参考：[AEC VOIP模式和诊断指南](AEC_VOIP模式和诊断指南.md)

---

## 📊 版本历史

| 版本 | 日期 | 主要变更 |
|------|------|----------|
| v2.4 | 2025-10-27 | 切换 VOIP 模式，移除预热机制 |
| v2.3 | 2025-10-27 | 添加降噪（NS）配置 |
| v2.2 | 2025-10-27 | AEC 时序同步修复 |
| v2.1 | 2025-10-27 | VAD 功能集成 |
| v2.0 | 2025-10-27 | 流式播放实现 |

---

## 🎯 关键差异

### v2.3 → v2.4 变化

| 项目 | v2.3 | v2.4 |
|------|------|------|
| AEC 模式 | `AEC_MODE_SR_HIGH_PERF` | `AEC_MODE_VOIP_HIGH_PERF` ✅ |
| VAD 检测 | 预热 10 个块后才检测 | 立即检测 ✅ |
| 降噪 | 已配置 | 保持 ✅ |
| 时序同步 | 已实现 | 保持 ✅ |

---

**更新日期**: 2025-10-27  
**版本**: v2.4  
**状态**: ✅ 代码已修改，等待用户测试反馈

