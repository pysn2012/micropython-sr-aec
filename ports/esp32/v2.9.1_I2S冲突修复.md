# v2.9.1 I2S冲突修复

## 🐛 问题描述

v2.9初次运行时报错：
```
E (2893) i2s_common: i2s_new_channel(972): no available channel found
```

导致C端播放线程启动了但无法播放音频。

## 🔍 根本原因

**I2S资源冲突**：
- `test_logic.py`在`__init__`中创建了`self.audio_out`（I2S1 TX）
- C端的`init_i2s`尝试创建I2S1 TX时，发现已被占用
- 导致`g_i2s_tx_handle`为NULL，播放线程启动但无法播放

## ✅ 解决方案

### 1. Python端修改 (`test_logic.py`)

**删除Python端的I2S初始化**：
```python
# ❌ 之前（会占用I2S1）
self.audio_out = I2S(
    1,
    sck=Pin(I2S_BCK_PIN),
    ws=Pin(I2S_WS_PIN),
    sd=Pin(I2S_SD_PIN),
    mode=I2S.TX,
    ...
)

# ✅ 现在（不再创建I2S）
# v2.9: 不再需要Python端的I2S，C端管理播放
# I2S播放由C端的playback_Task管理，避免冲突
```

### 2. C端修改 (`modespsr.c`)

**明确分离I2S0和I2S1**：
- **I2S0 RX (PDM)**: ESP-SR麦克风输入
- **I2S1 TX (STD)**: C端播放输出

```c
// I2S0: PDM RX（麦克风）
i2s_chan_config_t chan_cfg = {
    .id = I2S_NUM_0,
    ...
};
ESP_ERROR_CHECK(i2s_new_channel(&chan_cfg, NULL, &rx_handle));
ESP_ERROR_CHECK(i2s_channel_init_pdm_rx_mode(rx_handle, &pdm_rx_cfg));
ESP_ERROR_CHECK(i2s_channel_enable(rx_handle));

// I2S1: STD TX（播放）
i2s_chan_config_t tx_chan_cfg = {
    .id = I2S_NUM_1,
    ...
};
ESP_ERROR_CHECK(i2s_new_channel(&tx_chan_cfg, &g_i2s_tx_handle, NULL));
ESP_ERROR_CHECK(i2s_channel_init_std_mode(g_i2s_tx_handle, &tx_std_cfg));
ESP_ERROR_CHECK(i2s_channel_enable(g_i2s_tx_handle));
```

## 📁 修改文件

1. ✅ `ports/esp32/modules/test_logic.py` - 删除I2S初始化
2. ✅ `ports/esp32/modespsr.c` - 分离I2S0和I2S1

## 🚀 重新编译和测试

```bash
cd /Users/renzhaojing/gitcode/renhejia/micropython-sr-aec/ports/esp32
idf.py build flash
```

在MicroPython中运行：
```python
import test_logic
test_logic.run()
```

## 🔍 成功的日志

应该看到：
```
I (xxxx) espsr: I2S0 RX (PDM mic) initialized
I (xxxx) espsr: I2S1 TX (playback) initialized
I (xxxx) espsr: I2S initialized successfully (I2S0: PDM RX, I2S1: STD TX)
✅ ESP-SR 初始化成功
✅ C端播放线程已启动
I (xxxx) espsr: 🔊 已播放 100 块 (3.0秒)    ← C端播放日志！
```

**不应该再看到**：
```
❌ E (xxxx) i2s_common: i2s_new_channel(972): no available channel found
```

## 📊 I2S资源分配

| I2S外设 | 模式 | 用途 | GPIO |
|---------|------|------|------|
| **I2S0** | PDM RX | ESP-SR麦克风 | CLK=4, DIN=5 |
| **I2S1** | STD TX | C端播放 | BCLK=7, WS=15, DOUT=16 |

## 🎯 预期效果

1. ✅ I2S资源不再冲突
2. ✅ C端播放线程正常工作
3. ✅ 能听到音频播放
4. ✅ AEC喂入频率>90%
5. ✅ 不再被自己的声音打断

---

**v2.9.1修复完成！准备重新编译测试！** 🚀

