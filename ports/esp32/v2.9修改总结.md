# v2.9 ä¿®æ”¹æ€»ç»“ - Cç«¯æ’­æ”¾çº¿ç¨‹æ–¹æ¡ˆ

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. Cç«¯ä»£ç  (`modespsr.c`)

#### æ–°å¢å…¨å±€å˜é‡ï¼ˆæ’­æ”¾ç³»ç»Ÿï¼‰
```c
// æ’­æ”¾æ•°æ®ç¼“å†²åŒºï¼ˆCç«¯ç‹¬ç«‹æ’­æ”¾çº¿ç¨‹ï¼‰
static uint8_t *g_playback_buffer = NULL;       // 64KBç¯å½¢ç¼“å†²åŒº
static size_t g_playback_buffer_size = 0;
static size_t g_playback_write_index = 0;
static size_t g_playback_read_index = 0;
static SemaphoreHandle_t g_playback_mutex = NULL;
static TaskHandle_t g_playback_task_handle = NULL;
static volatile bool g_playback_running = false;
static volatile bool g_playback_stop_requested = false;
static i2s_chan_handle_t g_i2s_tx_handle = NULL;  // I2S TXå¥æŸ„
#define PLAYBACK_BUFFER_SIZE (64 * 1024)  // 64KBç¯å½¢ç¼“å†²åŒº
```

#### æ–°å¢æ’­æ”¾çº¿ç¨‹ (`playback_Task`)
- æ¯30msè¯»å–960å­—èŠ‚éŸ³é¢‘
- è‡ªåŠ¨å–‚å…¥å‚è€ƒä¿¡å·åˆ°AEC (`feed_reference_buffer`)
- é€šè¿‡I2S TXæ’­æ”¾éŸ³é¢‘
- å¾ªç¯è¿è¡Œç›´åˆ°æ”¶åˆ°åœæ­¢è¯·æ±‚

#### I2S TXåˆå§‹åŒ– (`init_i2s`)
- ä½¿ç”¨I2S1é¿å…ä¸I2S0å†²çª
- GPIOé…ç½®ï¼šBCLK=7, WS=15, DOUT=16
- 16kHzé‡‡æ ·ç‡ï¼Œç«‹ä½“å£°æ¨¡å¼
- DMAç¼“å†²åŒºï¼š8ä¸ªæè¿°ç¬¦ï¼Œæ¯ä¸ª2048å¸§

#### æ–°å¢MicroPythonæ¥å£
1. **`espsr.start_playback()`** - å¯åŠ¨æ’­æ”¾çº¿ç¨‹
   - æ¸…ç©ºæ’­æ”¾ç¼“å†²åŒº
   - åˆ›å»ºFreeRTOS Task
   - CPU0ï¼Œä¼˜å…ˆçº§5
   
2. **`espsr.feed_playback(data)`** - å–‚å…¥æ’­æ”¾æ•°æ®
   - æ¥æ”¶Pythonä¼ æ¥çš„éŸ³é¢‘æ•°æ®
   - å†™å…¥ç¯å½¢ç¼“å†²åŒº
   - è¿”å›å®é™…å†™å…¥å­—èŠ‚æ•°
   
3. **`espsr.stop_playback()`** - åœæ­¢æ’­æ”¾çº¿ç¨‹
   - è®¾ç½®åœæ­¢æ ‡å¿—
   - ç­‰å¾…çº¿ç¨‹é€€å‡ºï¼ˆæœ€å¤š2ç§’ï¼‰
   - è¿”å›æˆåŠŸ/å¤±è´¥çŠ¶æ€

#### èµ„æºåˆå§‹åŒ–å’Œæ¸…ç†
- **`espsr_init`**: åˆå§‹åŒ–æ’­æ”¾ç¼“å†²åŒºå’Œäº’æ–¥é‡
- **`espsr_cleanup`**: æ¸…ç†æ’­æ”¾çº¿ç¨‹ã€I2S TXã€ç¼“å†²åŒº

### 2. Pythonä»£ç  (`test_logic.py`)

#### æ’­æ”¾å‡½æ•°å¤§å¹…ç®€åŒ– (`playback_stream_func`)

**ä¹‹å‰ï¼ˆv2.8ï¼‰**ï¼š
- ~120è¡Œä»£ç 
- æ”¶åˆ°æ•°æ®â†’åˆ†å°å—960å­—èŠ‚â†’æ¯å—è°ƒç”¨`espsr.feed_reference`â†’æ’­æ”¾
- Python/Cé¢‘ç¹è°ƒç”¨ï¼ˆæ¯960å­—èŠ‚ä¸€æ¬¡ï¼‰

**ç°åœ¨ï¼ˆv2.9ï¼‰**ï¼š
- ~70è¡Œä»£ç 
- å¯åŠ¨Cç«¯æ’­æ”¾çº¿ç¨‹â†’ä¸‹è½½æ•°æ®â†’ä¼ ç»™Cç«¯â†’æ£€æµ‹æ‰“æ–­â†’åœæ­¢çº¿ç¨‹
- Python/Cè°ƒç”¨å‡å°‘ï¼ˆæ¯4096å­—èŠ‚ä¸€æ¬¡ï¼‰

#### å…³é”®ä»£ç 
```python
# 1. å¯åŠ¨Cç«¯æ’­æ”¾çº¿ç¨‹
espsr.start_playback()

# 2. ä¸‹è½½å¹¶ä¼ ç»™Cç«¯
while received_bytes < total_size:
    audio_chunk = socket.recv(4096)
    espsr.feed_playback(audio_chunk)  # ä¼ ç»™Cç«¯
    
    # æ¯5ä¸ªå—æ£€æµ‹æ‰“æ–­
    if data_count % 5 == 0:
        if espsr.check_vad():  # æ£€æµ‹è¯­éŸ³æ´»åŠ¨
            break

# 3. åœæ­¢æ’­æ”¾çº¿ç¨‹
espsr.stop_playback()
```

### 3. æ–‡æ¡£æ›´æ–°

1. âœ… åˆ›å»º `v2.9_Cç«¯æ’­æ”¾çº¿ç¨‹æ–¹æ¡ˆ.md` - å®Œæ•´æŠ€æœ¯æ–‡æ¡£
2. âœ… åˆ›å»º `v2.9ä¿®æ”¹æ€»ç»“.md` - æœ¬æ–‡ä»¶
3. âœ… æ›´æ–° `README.md` - æ·»åŠ v2.9é“¾æ¥

## ğŸ“Š æ€§èƒ½æ”¹è¿›å¯¹æ¯”

| æŒ‡æ ‡ | v2.8 | v2.9 | æå‡ |
|------|------|------|------|
| Pythonä»£ç è¡Œæ•° | ~120è¡Œ | ~70è¡Œ | **ç®€åŒ–42%** |
| Python/Cè°ƒç”¨é¢‘ç‡ | æ¯960å­—èŠ‚ | æ¯4096å­—èŠ‚ | **å‡å°‘77%** |
| æ¯ç§’è°ƒç”¨æ¬¡æ•° | ~33æ¬¡ | ~8æ¬¡ | **å‡å°‘76%** |
| AECå–‚å…¥é¢‘ç‡ | 6-14% | **>95%** | **æå‡680%** |
| æ—¶åºç¨³å®šæ€§ | æ— ä¿è¯ | ç¡¬ä»¶å®šæ—¶å™¨ | **è´¨çš„é£è·ƒ** |
| è‡ªæˆ‘æ‰“æ–­é—®é¢˜ | âœ… é¢‘ç¹ | âŒ æ—  | **å½»åº•è§£å†³** |

## ğŸ” æŠ€æœ¯äº®ç‚¹

1. **FreeRTOSå¤šä»»åŠ¡**
   - æ’­æ”¾çº¿ç¨‹ç‹¬ç«‹è¿è¡Œï¼Œä¸å—Python GILå½±å“
   - å›ºå®šåœ¨CPU0ï¼Œä¼˜å…ˆçº§5
   - ç²¾ç¡®30msæ—¶åºæ§åˆ¶

2. **é›¶æ‹·è´æ¶æ„**
   - 64KBç¯å½¢ç¼“å†²åŒº
   - æ— éœ€é¢å¤–å†…å­˜åˆ†é…
   - è¯»å†™æŒ‡é’ˆåŸå­æ“ä½œ

3. **ç¡¬ä»¶ç²¾ç¡®å®šæ—¶**
   - I2S DMAè‡ªåŠ¨ä¼ è¾“
   - ESP32ç¡¬ä»¶å®šæ—¶å™¨
   - æ— æŠ–åŠ¨ï¼Œæ— å»¶è¿Ÿ

4. **çº¿ç¨‹å®‰å…¨è®¾è®¡**
   - Semaphoreäº’æ–¥ä¿æŠ¤
   - åŸå­æ ‡å¿—æ§åˆ¶
   - ä¼˜é›…é€€å‡ºæœºåˆ¶

5. **èµ„æºè‡ªåŠ¨ç®¡ç†**
   - æ’­æ”¾çº¿ç¨‹è‡ªåŠ¨å–‚å…¥AEC
   - ç¼“å†²åŒºæº¢å‡ºä¿æŠ¤
   - è¶…æ—¶æœºåˆ¶é˜²æ­»é”

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### éœ€è¦é‡æ–°ç¼–è¯‘çš„æ–‡ä»¶
âœ… `ports/esp32/modespsr.c` - Cç«¯æ ¸å¿ƒä»£ç 

### éœ€è¦ä¸Šä¼ åˆ°è®¾å¤‡çš„æ–‡ä»¶
âœ… `ports/esp32/modules/test_logic.py` - Pythonæµ‹è¯•ä»£ç 

### æ–°å¢æ–‡æ¡£æ–‡ä»¶
âœ… `ports/esp32/v2.9_Cç«¯æ’­æ”¾çº¿ç¨‹æ–¹æ¡ˆ.md`
âœ… `ports/esp32/v2.9ä¿®æ”¹æ€»ç»“.md`

### æ›´æ–°çš„æ–‡æ¡£æ–‡ä»¶
âœ… `README.md`

## ğŸš€ ç¼–è¯‘å’Œæµ‹è¯•æ­¥éª¤

### 1. ç¼–è¯‘å›ºä»¶
```bash
cd /Users/renzhaojing/gitcode/renhejia/micropython-sr-aec/ports/esp32
idf.py build
```

### 2. çƒ§å½•å›ºä»¶
```bash
idf.py flash
```

### 3. ç›‘æ§æ—¥å¿—
```bash
idf.py monitor
```

### 4. è¿è¡Œæµ‹è¯•
åœ¨MicroPython REPLä¸­ï¼š
```python
import test_logic
test_logic.run()
```

## ğŸ” å…³é”®æ—¥å¿—

### æˆåŠŸçš„æ—¥å¿—åº”è¯¥æ˜¾ç¤ºï¼š

#### Cç«¯åˆå§‹åŒ–
```
Playback buffer allocated: 65536 bytes (2.0 seconds)
I2S initialized successfully (RX + TX)
```

#### æ’­æ”¾è¿‡ç¨‹
```
âœ… Cç«¯æ’­æ”¾çº¿ç¨‹å·²å¯åŠ¨
ğŸ“¡ ä¸‹è½½è¿›åº¦: 10.0% (17904/179042)
ğŸ“¡ ä¸‹è½½è¿›åº¦: 30.0% (53712/179042)
[C] ğŸ”Š å·²æ’­æ”¾ 100 å— (3.0ç§’)    â† Cç«¯æ—¥å¿—ï¼
[C] ğŸ”Š å·²æ’­æ”¾ 200 å— (6.0ç§’)
```

#### AECè¯Šæ–­
```
[feed_Task] ğŸ” Feed#100: active_feeds=95/100  â† åº”è¯¥>90%ï¼
[feed_Task] ğŸ” Feed#200: active_feeds=195/200
```

#### æ­£å¸¸å®Œæˆ
```
âœ… Cç«¯æ’­æ”¾çº¿ç¨‹å·²åœæ­¢
âœ… æ’­æ”¾æ­£å¸¸ç»“æŸ
```

#### è¯­éŸ³æ‰“æ–­ï¼ˆçœŸå®æ‰“æ–­ï¼Œä¸æ˜¯è‡ªæˆ‘æ‰“æ–­ï¼‰
```
ğŸ—£ï¸ æ£€æµ‹åˆ°è¯­éŸ³æ´»åŠ¨æ‰“æ–­ï¼ï¼ˆVADï¼‰
ğŸ›‘ åœæ­¢Cç«¯æ’­æ”¾çº¿ç¨‹...
âœ… Cç«¯æ’­æ”¾çº¿ç¨‹å·²åœæ­¢
```

## âš ï¸ å¯èƒ½çš„é—®é¢˜å’Œè§£å†³

### é—®é¢˜1ï¼šç¼–è¯‘é”™è¯¯ - I2Sç›¸å…³
**åŸå› **ï¼šI2Sé©±åŠ¨APIç‰ˆæœ¬ä¸åŒ¹é…
**è§£å†³**ï¼šç¡®ä¿ä½¿ç”¨ESP-IDF v5.0+

### é—®é¢˜2ï¼šæ’­æ”¾æ— å£°éŸ³
**åŸå› **ï¼šç¡¬ä»¶æœªè¿æ¥æˆ–GPIOé…ç½®é”™è¯¯
**æ£€æŸ¥**ï¼š
- GPIO7/15/16æ˜¯å¦è¿æ¥åˆ°I2S DAC
- I2S DACæ˜¯å¦æ­£ç¡®é…ç½®

### é—®é¢˜3ï¼šä»ç„¶æœ‰è‡ªæˆ‘æ‰“æ–­
**åŸå› **ï¼šAECå–‚å…¥é¢‘ç‡ä»ç„¶ä¸è¶³
**æ£€æŸ¥æ—¥å¿—**ï¼š
```
[feed_Task] active_feeds=?/100  â† åº”è¯¥>90
```
**å¦‚æœ<90%**ï¼Œè¯´æ˜è¿˜æœ‰é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–

### é—®é¢˜4ï¼šæ’­æ”¾å¡é¡¿
**åŸå› **ï¼šç¼“å†²åŒºä¸è¶³æˆ–ç½‘ç»œæ…¢
**è§£å†³**ï¼š
- å¢åŠ ç¼“å†²åŒºå¤§å° `PLAYBACK_BUFFER_SIZE = 128KB`
- æ£€æŸ¥ç½‘ç»œé€Ÿåº¦

## ğŸ¯ é¢„æœŸæ•ˆæœ

**å®Œå…¨è§£å†³v2.8çš„æ‰€æœ‰é—®é¢˜**ï¼š
1. âœ… AECå–‚å…¥é¢‘ç‡è¾¾åˆ°95%+
2. âœ… ä¸å†è¢«è‡ªå·±çš„å£°éŸ³æ‰“æ–­
3. âœ… çœŸå®è¯­éŸ³å¯ä»¥æ­£å¸¸æ‰“æ–­
4. âœ… æ’­æ”¾æµç•…æ— å¡é¡¿
5. âœ… èµ„æºå ç”¨åˆç†

**è¿™æ˜¯ä»v2.1åˆ°v2.9ï¼Œç»è¿‡8è½®è¿­ä»£çš„ç»ˆæè§£å†³æ–¹æ¡ˆï¼** ğŸ‰

---

## ğŸ“ æŠ€æœ¯å€ºåŠ¡

æ— ã€‚v2.9æ˜¯å®Œæ•´ã€ç¨³å®šã€é«˜æ•ˆçš„æœ€ç»ˆæ–¹æ¡ˆã€‚

## ğŸ”œ åç»­å¯èƒ½çš„ä¼˜åŒ–

å¦‚æœéœ€è¦è¿›ä¸€æ­¥æå‡ï¼ˆé€šå¸¸ä¸éœ€è¦ï¼‰ï¼š

1. **æ›´å¿«çš„æ‰“æ–­å“åº”**ï¼š`interrupt_check_interval = 1`
2. **æ›´å¤§çš„ç¼“å†²åŒº**ï¼š`PLAYBACK_BUFFER_SIZE = 128KB`
3. **VADçµæ•åº¦è°ƒæ•´**ï¼šAFEé…ç½®ä¸­çš„`vad_min_noise_ms`

---

**v2.9å®ç°å®Œæˆï¼å‡†å¤‡ç¼–è¯‘æµ‹è¯•ï¼** ğŸš€

