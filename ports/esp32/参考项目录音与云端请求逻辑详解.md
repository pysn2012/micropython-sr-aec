# å‚è€ƒé¡¹ç›®å½•éŸ³ä¸äº‘ç«¯è¯·æ±‚é€»è¾‘è¯¦è§£

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

> "å‚è€ƒé¡¹ç›®çš„å½•éŸ³ä¸€ç›´å¼€ç€ï¼Œä¼šä¸€ç›´è¯·æ±‚äº‘ç«¯å—ï¼Ÿä»€ä¹ˆæ—¶å€™ä¼šå¯¹äº‘ç«¯è¯·æ±‚ï¼Ÿ"

---

## âœ… æ ¸å¿ƒç­”æ¡ˆ

**ä¸ä¼šä¸€ç›´è¯·æ±‚äº‘ç«¯ï¼**

- **"å½•éŸ³ä¸€ç›´å¼€ç€"** = AudioLoop æŒç»­è¯»å–éŸ³é¢‘æ•°æ®
- **"è¯·æ±‚äº‘ç«¯"** = åªåœ¨ç‰¹å®šçŠ¶æ€ï¼ˆListeningï¼‰ä¸‹æ‰å‘é€

---

## ğŸ“Š AudioLoop çš„æ•°æ®åˆ†å‘æœºåˆ¶

### å®Œæ•´ä»£ç åˆ†æ

```cpp
void Application::AudioLoop() {
    auto codec = Board::GetInstance().GetAudioCodec();
    while (true) {
        OnAudioInput();    // â† æŒç»­è°ƒç”¨
        if (codec->output_enabled()) {
            OnAudioOutput();
        }
    }
}

void Application::OnAudioInput() {
    // ========== æƒ…å†µ 1: å”¤é†’è¯æ£€æµ‹è¿è¡Œä¸­ ==========
    #if CONFIG_USE_WAKE_WORD_DETECT
    if (wake_word_detect_.IsDetectionRunning()) {
        std::vector<int16_t> data;
        int samples = wake_word_detect_.GetFeedSize();
        if (samples > 0) {
            ReadAudio(data, 16000, samples);
            wake_word_detect_.Feed(data);  // â† åªå–‚ç»™æ£€æµ‹å™¨ï¼Œä¸ä¸Šä¼ ï¼
            return;
        }
    }
    #endif
    
    // ========== æƒ…å†µ 2: å½•éŸ³ä¸Šä¼ æ¨¡å¼ ==========
    #if CONFIG_USE_AUDIO_PROCESSOR
    // ... (ä½¿ç”¨ audio_processor çš„æƒ…å†µ)
    #else
    if (device_state_ == kDeviceStateListening) {
        std::vector<int16_t> data;
        ReadAudio(data, 16000, 30 * 16000 / 1000);
        background_task_->Schedule([this, data = std::move(data)]() mutable {
            if (protocol_->IsAudioChannelBusy()) {
                return;
            }
            opus_encoder_->Encode(std::move(data), [this](std::vector<uint8_t>&& opus) {
                Schedule([this, opus = std::move(opus)]() {
                    protocol_->SendAudio(opus);  // â† å‘é€åˆ°äº‘ç«¯ï¼
                });
            });
        });
        return;
    }
    #endif
    
    // ========== æƒ…å†µ 3: å…¶ä»–çŠ¶æ€ ==========
    vTaskDelay(pdMS_TO_TICKS(30));  // â† ç­‰å¾… 30msï¼Œä¸å¤„ç†éŸ³é¢‘
}
```

---

## ğŸ” è¯¦ç»†è¯´æ˜

### æƒ…å†µ 1: å¾…æœºçŠ¶æ€ (Idle)

**çŠ¶æ€**ï¼š`device_state_ = kDeviceStateIdle`

**æ£€æµ‹è¿è¡Œ**ï¼š`wake_word_detect_.IsDetectionRunning() = true`

```cpp
if (wake_word_detect_.IsDetectionRunning()) {
    ReadAudio(data);                    // 1. è¯»å–éŸ³é¢‘
    wake_word_detect_.Feed(data);       // 2. å–‚ç»™å”¤é†’è¯æ£€æµ‹å™¨
    return;                              // 3. ç›´æ¥è¿”å›ï¼Œä¸å‘é€ï¼
}
```

**æ•°æ®å»å‘**ï¼š
- âœ… éŸ³é¢‘ â†’ AFE â†’ MultiNet â†’ æœ¬åœ°æ£€æµ‹
- âŒ **ä¸å‘é€åˆ°äº‘ç«¯**

**ç‰¹ç‚¹**ï¼š
- æœ¬åœ°å¤„ç†ï¼Œä¸å ç”¨ç½‘ç»œå¸¦å®½
- åªæ£€æµ‹å”¤é†’è¯
- ä½åŠŸè€—ã€ä½å»¶è¿Ÿ

---

### æƒ…å†µ 2: å½•éŸ³çŠ¶æ€ (Listening)

**çŠ¶æ€**ï¼š`device_state_ = kDeviceStateListening`

**æ£€æµ‹è¿è¡Œ**ï¼š`wake_word_detect_.IsDetectionRunning() = false`ï¼ˆå·²åœæ­¢ï¼‰

```cpp
if (device_state_ == kDeviceStateListening) {
    ReadAudio(data);                    // 1. è¯»å–éŸ³é¢‘
    opus_encoder_->Encode(data);        // 2. ç¼–ç ä¸º Opus
    protocol_->SendAudio(opus);         // 3. å‘é€åˆ°äº‘ç«¯ âœ…
    return;
}
```

**æ•°æ®å»å‘**ï¼š
- âœ… éŸ³é¢‘ â†’ Opus ç¼–ç  â†’ äº‘ç«¯æœåŠ¡å™¨
- âŒ ä¸å†æœ¬åœ°æ£€æµ‹ï¼ˆå·²åœæ­¢ï¼‰

**ç‰¹ç‚¹**ï¼š
- æŒç»­å‘é€åˆ°äº‘ç«¯
- ç”¨äºè¯­éŸ³è¯†åˆ«
- å ç”¨ç½‘ç»œå¸¦å®½

---

### æƒ…å†µ 3: æ’­æ”¾çŠ¶æ€ (Speaking)

**çŠ¶æ€**ï¼š`device_state_ = kDeviceStateSpeaking`

**æ£€æµ‹è¿è¡Œ**ï¼š`wake_word_detect_.IsDetectionRunning() = true`ï¼ˆé‡æ–°å¯åŠ¨ï¼‰

```cpp
if (wake_word_detect_.IsDetectionRunning()) {
    ReadAudio(data);                    // 1. è¯»å–éŸ³é¢‘
    wake_word_detect_.Feed(data);       // 2. å–‚ç»™æ£€æµ‹å™¨ï¼ˆæ£€æµ‹æ‰“æ–­ï¼‰
    return;                              // 3. ä¸å‘é€åˆ°äº‘ç«¯
}
```

**æ•°æ®å»å‘**ï¼š
- âœ… éŸ³é¢‘ â†’ AFE â†’ MultiNet â†’ æœ¬åœ°æ£€æµ‹ï¼ˆæ£€æµ‹æ‰“æ–­ï¼‰
- âŒ **ä¸å‘é€åˆ°äº‘ç«¯**

**ç‰¹ç‚¹**ï¼š
- æ’­æ”¾æœŸé—´æ£€æµ‹æ‰“æ–­
- ä¸ä¸Šä¼ éŸ³é¢‘åˆ°äº‘ç«¯
- AEC å¤„ç†å‚è€ƒä¿¡å·

---

## ğŸ“Š çŠ¶æ€è½¬æ¢ä¸äº‘ç«¯è¯·æ±‚æ—¶æœº

### å®Œæ•´æµç¨‹

```
1. å¾…æœº (Idle)
   â””â”€ wake_word_detect_.IsDetectionRunning() = true
   â””â”€ AudioLoop: è¯»éŸ³é¢‘ â†’ æœ¬åœ°æ£€æµ‹
   â””â”€ âŒ ä¸å‘é€äº‘ç«¯

2. æ£€æµ‹åˆ°å”¤é†’è¯
   â””â”€ wake_word_detect_.StopDetection()  â† åœæ­¢æ£€æµ‹
   â””â”€ SetDeviceState(Listening)          â† åˆ‡æ¢çŠ¶æ€

3. å½•éŸ³ä¸Šä¼  (Listening)
   â””â”€ wake_word_detect_.IsDetectionRunning() = false
   â””â”€ device_state_ = Listening
   â””â”€ AudioLoop: è¯»éŸ³é¢‘ â†’ ç¼–ç  â†’ âœ… å‘é€äº‘ç«¯
   
4. äº‘ç«¯è¿”å› tts:start
   â””â”€ SetDeviceState(Speaking)           â† åˆ‡æ¢çŠ¶æ€
   â””â”€ wake_word_detect_.StartDetection() â† é‡æ–°å¯åŠ¨æ£€æµ‹

5. æ’­æ”¾å›å¤ (Speaking)
   â””â”€ wake_word_detect_.IsDetectionRunning() = true
   â””â”€ AudioLoop: è¯»éŸ³é¢‘ â†’ æœ¬åœ°æ£€æµ‹ï¼ˆæ‰“æ–­ï¼‰
   â””â”€ âŒ ä¸å‘é€äº‘ç«¯

6. æ’­æ”¾å®Œæˆ / è¢«æ‰“æ–­
   â””â”€ SetDeviceState(Idle)
   â””â”€ å›åˆ°å¾…æœº
```

---

## ğŸ¯ ä»€ä¹ˆæ—¶å€™è¯·æ±‚äº‘ç«¯ï¼Ÿ

### å”¯ä¸€è§¦å‘æ¡ä»¶

**åªæœ‰å½“ `device_state_ == kDeviceStateListening` æ—¶æ‰å‘é€ï¼**

### å¦‚ä½•è¿›å…¥ Listening çŠ¶æ€ï¼Ÿ

#### æ–¹å¼ 1: æ£€æµ‹åˆ°å”¤é†’è¯

```cpp
wake_word_detect_.OnWakeWordDetected([this](wake_word) {
    if (device_state_ == kDeviceStateIdle) {
        wake_word_detect_.StopDetection();       // åœæ­¢æ£€æµ‹
        protocol_->OpenAudioChannel();           // æ‰“å¼€éŸ³é¢‘é€šé“
        
        // å‘é€å”¤é†’è¯PCMæ•°æ®
        while (wake_word_detect_.GetWakeWordOpus(opus)) {
            protocol_->SendAudio(opus);          // å‘é€å”¤é†’è¯
        }
        protocol_->SendWakeWordDetected(wake_word);
        
        SetListeningMode(kListeningModeAutoStop);  // â†’ Listening
    }
});
```

**æµç¨‹**ï¼š
1. æ£€æµ‹åˆ°"å—¨å°ä¹"
2. å‘é€å”¤é†’è¯æ•°æ®ï¼ˆçº¦ 2 ç§’çš„ PCMï¼‰
3. å‘é€å”¤é†’è¯æ ‡è¯†
4. åˆ‡æ¢åˆ° Listening çŠ¶æ€
5. **å¼€å§‹æŒç»­ä¸Šä¼ éŸ³é¢‘**

#### æ–¹å¼ 2: æ‰‹åŠ¨å”¤é†’ï¼ˆæŒ‰é”®ï¼‰

```cpp
void Application::StartListening() {
    if (device_state_ == kDeviceStateIdle) {
        protocol_->OpenAudioChannel();
        SetListeningMode(kListeningModeManualStop);  // â†’ Listening
    }
}
```

#### æ–¹å¼ 3: æ’­æ”¾è¢«æ‰“æ–­

```cpp
if (device_state_ == kDeviceStateSpeaking) {
    AbortSpeaking(kAbortReasonWakeWordDetected);
    SetListeningMode(kListeningModeManualStop);  // â†’ Listening
}
```

---

## ğŸ“Š æ•°æ®æµå‘å¯¹æ¯”

### å¾…æœºæ—¶ (Idle)

```
[éº¦å…‹é£] â†’ AudioLoop::ReadAudio()
               â†“
    wake_word_detect_.Feed()
               â†“
         AFE (æœ¬åœ°å¤„ç†)
               â†“
         MultiNet (æœ¬åœ°æ£€æµ‹)
               â†“
    æ£€æµ‹åˆ°å”¤é†’è¯ â†’ å›è°ƒè§¦å‘
    
âŒ ä¸å‘é€åˆ°äº‘ç«¯
âœ… æœ¬åœ°å¤„ç†ï¼Œä½å»¶è¿Ÿ
```

### å½•éŸ³æ—¶ (Listening)

```
[éº¦å…‹é£] â†’ AudioLoop::ReadAudio()
               â†“
      opus_encoder_->Encode()
               â†“
      protocol_->SendAudio()
               â†“
         äº‘ç«¯æœåŠ¡å™¨
               â†“
      è¯­éŸ³è¯†åˆ« (ASR)
               â†“
         è¿”å›æ–‡æœ¬
    
âœ… å‘é€åˆ°äº‘ç«¯
âŒ æœ¬åœ°ä¸æ£€æµ‹ï¼ˆæ£€æµ‹å·²åœæ­¢ï¼‰
```

### æ’­æ”¾æ—¶ (Speaking)

```
[éº¦å…‹é£] â†’ AudioLoop::ReadAudio()
               â†“
    wake_word_detect_.Feed()
               â†“
         AFE (æœ¬åœ°å¤„ç† + AEC)
               â†“
         MultiNet (æœ¬åœ°æ£€æµ‹æ‰“æ–­)
               â†“
    æ£€æµ‹åˆ°å”¤é†’è¯ â†’ AbortSpeaking()
    
âŒ ä¸å‘é€åˆ°äº‘ç«¯
âœ… æœ¬åœ°æ£€æµ‹æ‰“æ–­ï¼ŒAEC å¤„ç†å›å£°
```

---

## ğŸ’¡ ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

### 1. èŠ‚çœå¸¦å®½

**å¾…æœºæ—¶**ï¼š
- å¤§éƒ¨åˆ†æ—¶é—´å¤„äºå¾…æœº
- å¦‚æœæŒç»­ä¸Šä¼  â†’ æµªè´¹å¤§é‡å¸¦å®½
- æœ¬åœ°æ£€æµ‹è¶³å¤Ÿå¿«ï¼ˆ<100msï¼‰

**è®¡ç®—**ï¼š
- é‡‡æ ·ç‡ï¼š16000 Hz
- ä½æ·±åº¦ï¼š16 bit
- å¸¦å®½ï¼š16000 * 2 = 32 KB/s
- 24 å°æ—¶ = 2.7 GB âŒ

### 2. é™ä½å»¶è¿Ÿ

**æœ¬åœ°æ£€æµ‹**ï¼š
- å”¤é†’è¯æ£€æµ‹ï¼š50~100ms
- æ— ç½‘ç»œå»¶è¿Ÿ

**äº‘ç«¯è¯†åˆ«**ï¼š
- ç½‘ç»œå»¶è¿Ÿï¼š50~200ms
- ASR å¤„ç†ï¼š100~300ms
- æ€»å»¶è¿Ÿï¼š150~500ms

**ç­–ç•¥**ï¼š
- å”¤é†’è¯ â†’ æœ¬åœ°æ£€æµ‹ï¼ˆå¿«ï¼‰
- è¯­éŸ³è¯†åˆ« â†’ äº‘ç«¯å¤„ç†ï¼ˆå‡†ç¡®ï¼‰

### 3. ä¿æŠ¤éšç§

**å¾…æœºæ—¶**ï¼š
- éŸ³é¢‘åªåœ¨æœ¬åœ°å¤„ç†
- ä¸ä¸Šä¼ åˆ°äº‘ç«¯
- åªæœ‰æ£€æµ‹åˆ°å”¤é†’è¯æ‰ä¸Šä¼ 

**ç”¨æˆ·éšç§**ï¼š
- æ—¥å¸¸å¯¹è¯ä¸ä¼šè¢«å½•éŸ³
- åªæœ‰ä¸»åŠ¨å”¤é†’åçš„å†…å®¹ä¸Šä¼ 

---

## ğŸ” ä¸å½“å‰ MicroPython å®ç°çš„å¯¹æ¯”

### å‚è€ƒé¡¹ç›® (C++)

| é˜¶æ®µ | AudioLoop è¿è¡Œ | æ•°æ®å»å‘ | äº‘ç«¯è¯·æ±‚ |
|------|---------------|---------|---------|
| å¾…æœº | âœ… æŒç»­ | æœ¬åœ°æ£€æµ‹ | âŒ å¦ |
| å½•éŸ³ | âœ… æŒç»­ | äº‘ç«¯ä¸Šä¼  | âœ… **æ˜¯** |
| æ’­æ”¾ | âœ… æŒç»­ | æœ¬åœ°æ£€æµ‹ï¼ˆæ‰“æ–­ï¼‰ | âŒ å¦ |

### å½“å‰å®ç° (MicroPython)

| é˜¶æ®µ | feed_Task è¿è¡Œ | æ•°æ®å»å‘ | äº‘ç«¯è¯·æ±‚ |
|------|---------------|---------|---------|
| å¾…æœº | âœ… æŒç»­ | AFE â†’ MultiNet | âŒ å¦ |
| å½•éŸ³ | âœ… æŒç»­ | espsr.read_audio() â†’ äº‘ç«¯ | âœ… **æ˜¯** |
| æ’­æ”¾ | âœ… æŒç»­ | AFE â†’ MultiNetï¼ˆæ‰“æ–­ï¼‰ | âŒ å¦ |

**å¯¹é½åº¦**ï¼šâœ… å®Œå…¨ä¸€è‡´ï¼

---

## ğŸ“‹ å½“å‰å®ç°çš„äº‘ç«¯è¯·æ±‚æ—¶æœº

### Python å±‚æ§åˆ¶

```python
def recordToAI(self):
    # 1. å¯ç”¨å½•éŸ³ç¼“å†²åŒº
    espsr.start_recording()
    
    # 2. ä¸»åŠ¨è¯»å–å¹¶å‘é€ï¼ˆè¿™é‡Œæ‰è¯·æ±‚äº‘ç«¯ï¼‰
    self.record_and_send()  # â† äº‘ç«¯è¯·æ±‚å‘ç”Ÿåœ¨è¿™é‡Œï¼

def record_and_send(self):
    while recorded_bytes < total_bytes:
        # ä»ç¼“å†²åŒºè¯»å–
        bytes_read = espsr.read_audio(buffer)
        
        # å‘é€åˆ°äº‘ç«¯
        s.send(buffer[:bytes_read])  # â† è¿™é‡Œå‘é€ï¼
        
        # æ£€æµ‹é™éŸ³ï¼Œåœæ­¢å‘é€
        if detect_silence():
            break
    
    # å‘é€ç»“æŸæ ‡è®°
    s.send(end_marker)
    
    # æ¥æ”¶å’Œæ’­æ”¾å“åº”
    self.process_server_response(s)
```

**å…³é”®ç‚¹**ï¼š
1. âœ… `espsr.start_recording()` åªå¯ç”¨ç¼“å†²åŒº
2. âœ… `record_and_send()` æ‰è¯»å–å¹¶å‘é€
3. âœ… é™éŸ³æ£€æµ‹ååœæ­¢å‘é€
4. âŒ **æ’­æ”¾æœŸé—´ä¸å‘é€**

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **"å½•éŸ³ä¸€ç›´å¼€ç€" â‰  "ä¸€ç›´è¯·æ±‚äº‘ç«¯"**
   - AudioLoop æŒç»­è¿è¡Œï¼ŒæŒç»­è¯»å–éŸ³é¢‘
   - ä½†æ•°æ®å»å‘æ ¹æ®çŠ¶æ€å†³å®š

2. **åªæœ‰ Listening çŠ¶æ€æ‰è¯·æ±‚äº‘ç«¯**
   - å¾…æœºæ—¶ï¼šæœ¬åœ°æ£€æµ‹ï¼Œä¸ä¸Šä¼ 
   - å½•éŸ³æ—¶ï¼šç¼–ç ä¸Šä¼ ï¼Œä¸æ£€æµ‹
   - æ’­æ”¾æ—¶ï¼šæœ¬åœ°æ£€æµ‹æ‰“æ–­ï¼Œä¸ä¸Šä¼ 

3. **å½“å‰å®ç°å®Œå…¨å¯¹é½å‚è€ƒé¡¹ç›®**
   - feed_Task æŒç»­è¿è¡Œï¼ˆç±»ä¼¼ AudioLoopï¼‰
   - `record_and_send()` æ—¶æ‰ä¸Šä¼ ï¼ˆç±»ä¼¼ Listening çŠ¶æ€ï¼‰
   - æ’­æ”¾æ—¶æ£€æµ‹æ‰“æ–­ï¼Œä¸ä¸Šä¼ ï¼ˆç±»ä¼¼ Speaking çŠ¶æ€ï¼‰

### äº‘ç«¯è¯·æ±‚æ—¶æœº

**å‚è€ƒé¡¹ç›®**ï¼š
```
æ£€æµ‹åˆ°å”¤é†’è¯ 
  â†’ SetDeviceState(Listening)
  â†’ AudioLoop: ReadAudio â†’ Encode â†’ SendAudio
  â†’ æŒç»­ä¸Šä¼ ç›´åˆ°é™éŸ³æˆ–æœåŠ¡å™¨è¿”å› tts:start
```

**å½“å‰å®ç°**ï¼š
```
æ£€æµ‹åˆ°å”¤é†’è¯
  â†’ recordToAI()
  â†’ espsr.start_recording()
  â†’ record_and_send()
      â†’ espsr.read_audio() â†’ s.send()
      â†’ æŒç»­ä¸Šä¼ ç›´åˆ°é™éŸ³æ£€æµ‹
```

### è®¾è®¡ä¼˜åŠ¿

1. **èŠ‚çœå¸¦å®½**ï¼šå¾…æœºæ—¶ä¸ä¸Šä¼ 
2. **é™ä½å»¶è¿Ÿ**ï¼šæœ¬åœ°æ£€æµ‹å¿«é€Ÿå“åº”
3. **ä¿æŠ¤éšç§**ï¼šåªä¸Šä¼ ä¸»åŠ¨å”¤é†’åçš„å†…å®¹
4. **æ”¯æŒæ‰“æ–­**ï¼šæ’­æ”¾æ—¶ç»§ç»­æœ¬åœ°æ£€æµ‹

---

## æ›´æ–°æ—¥æœŸ

2025-10-27

