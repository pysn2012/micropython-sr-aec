# logic.py å®ç°éªŒè¯æ¸…å•

## å¯¹æ¯”ï¼šå½“å‰å®ç° vs ã€Šå½•éŸ³ä¸AECé€»è¾‘å¯¹æ¯”è¯´æ˜.mdã€‹

### âœ… æ ¸å¿ƒåŸç†å¯¹é½

| é¡¹ç›® | æ–‡æ¡£æè¿° | å½“å‰å®ç° | çŠ¶æ€ |
|------|---------|---------|------|
| **å½•éŸ³æ¨¡å¼ â‰  å‘é€æ•°æ®** | å½•éŸ³æ¨¡å¼åªå¯ç”¨ç¼“å†²åŒºå†™å…¥ | âœ… `espsr.start_recording()` | **ä¸€è‡´** |
| **ä¸»åŠ¨å‘é€** | `record_and_send()` ä¸»åŠ¨è¯»å–å¹¶å‘é€ | âœ… `espsr.read_audio()` + `s.send()` | **ä¸€è‡´** |
| **åœæ­¢å‘é€æ¡ä»¶** | é™éŸ³æ£€æµ‹/è¶…æ—¶/æ‰‹åŠ¨ä¸­æ–­ | âœ… è¡Œ 196-213 | **ä¸€è‡´** |

---

## ğŸ“ é€å‡½æ•°å¯¹æ¯”

### 1. `initRecordMic()` - å¯ç”¨å½•éŸ³æ¨¡å¼

#### æ–‡æ¡£æè¿°ï¼š
```python
def initRecordMic(self):
    espsr.start_recording()  # åªå¯ç”¨ç¼“å†²åŒºå†™å…¥
```

#### å½“å‰å®ç° (è¡Œ 116-130)ï¼š
```python
def initRecordMic(self):
    """å¯ç”¨å½•éŸ³æ¨¡å¼ï¼ˆä½¿ç”¨ESP-SRçš„å…±äº«I2Sï¼Œé¿å…èµ„æºå†²çªï¼‰"""
    try:
        print("ğŸ™ï¸ å¯ç”¨ESP-SRå½•éŸ³æ¨¡å¼...")
        result = espsr.start_recording()
        if result:
            print("âœ… å½•éŸ³æ¨¡å¼å·²å¯ç”¨")
            self.is_init_record_mic = True
```

**âœ… ä¸€è‡´æ€§éªŒè¯**ï¼š
- âœ… è°ƒç”¨ `espsr.start_recording()`
- âœ… ä¸åˆ›å»º I2S å®ä¾‹
- âœ… åªå¯ç”¨ç¼“å†²åŒºå†™å…¥

---

### 2. `record_and_send()` - ä¸»åŠ¨è¯»å–å¹¶å‘é€

#### æ–‡æ¡£æè¿°ï¼š
```python
def record_and_send(self):
    while recorded_bytes < total_bytes:
        bytes_read = espsr.read_audio(buffer)  # ä¸»åŠ¨è¯»å–
        s.send(buffer[:bytes_read])            # å‘é€æ•°æ®
        
        if detect_silence():
            break  # åœæ­¢å‘é€
```

#### å½“å‰å®ç° (è¡Œ 169-213)ï¼š
```python
while recorded_bytes < total_bytes and not self.should_stop:
    # ä»ESP-SRçš„å½•éŸ³ç¼“å†²åŒºè¯»å–éŸ³é¢‘æ•°æ®
    bytes_read = espsr.read_audio(buffer)
    
    # å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯»å–
    if bytes_read == 0:
        time.sleep_ms(10)
        continue
    
    if bytes_read > 0:
        # å‘é€éŸ³é¢‘æ•°æ®
        s.send(struct.pack('<I', bytes_read))
        s.send(buffer[:bytes_read])
        recorded_bytes += bytes_read
        
        # é™éŸ³æ£€æµ‹å¤„ç†
        if energy < SILENCE_THRESHOLD:
            silent_samples += 1
            if silent_samples >= silence_threshold_windows:
                print("æ£€æµ‹åˆ°é™éŸ³ï¼Œç»“æŸå½•éŸ³")
                self.record_finish = True
                break
```

**âœ… ä¸€è‡´æ€§éªŒè¯**ï¼š
- âœ… ä½¿ç”¨ `espsr.read_audio()` ä¸»åŠ¨è¯»å–
- âœ… ä½¿ç”¨ `s.send()` å‘é€æ•°æ®
- âœ… é™éŸ³æ£€æµ‹åœæ­¢å‘é€
- âœ… è¶…æ—¶åœæ­¢å‘é€
- âœ… æ‰‹åŠ¨ä¸­æ–­åœæ­¢å‘é€

---

### 3. `recordToAI()` - ä¿æŒå½•éŸ³æ¨¡å¼å¼€å¯

#### æ–‡æ¡£æè¿°ï¼š
```python
def recordToAI(self):
    if not self.is_init_record_mic:
        self.initRecordMic()
    
    self.record_and_send()
    
    # âš ï¸ é‡è¦ï¼šä¸åœæ­¢å½•éŸ³ï¼
    print("end recordToAI (å½•éŸ³æ¨¡å¼ä¿æŒå¼€å¯)")
```

#### å½“å‰å®ç° (è¡Œ 488-517)ï¼š
```python
def recordToAI(self):
    print("start recordToAI")
    
    if not self.is_init_record_mic:
        self.initRecordMic()

    self.record_and_send()

    # æ£€æŸ¥æ˜¯å¦è¢«æ‰“æ–­
    if self.wakeup_interrupted:
        print("ğŸ”„ æ£€æµ‹åˆ°æ‰“æ–­ï¼Œå‡†å¤‡é‡æ–°å½•éŸ³")
        self.wakeup_interrupted = False
        print("ğŸ¤ é‡æ–°å¼€å§‹å½•éŸ³...")
        self.record_and_send()
        
        if self.wakeup_interrupted:
            print("ğŸ”„ å†æ¬¡è¢«æ‰“æ–­ï¼Œè¿›è¡Œèµ„æºæ¸…ç†")
            self.wakeup_interrupted = False
            self.deinit_record_mic()
            return
    
    # âš ï¸ é‡è¦ï¼šä¸è¦åœ¨è¿™é‡Œåœæ­¢å½•éŸ³ï¼æ’­æ”¾æœŸé—´éœ€è¦ä¿æŒå½•éŸ³æ¨¡å¼ä»¥æ£€æµ‹æ‰“æ–­
    # å½•éŸ³æ¨¡å¼ä¼šåœ¨æ’­æ”¾çº¿ç¨‹ç»“æŸåç”±ä¸»å¾ªç¯æ¸…ç†
    print("end recordToAI (å½•éŸ³æ¨¡å¼ä¿æŒå¼€å¯)")
```

**âœ… ä¸€è‡´æ€§éªŒè¯**ï¼š
- âœ… ä¸è°ƒç”¨ `deinit_record_mic()`
- âœ… æ³¨é‡Šè¯´æ˜ä¿æŒå½•éŸ³æ¨¡å¼å¼€å¯
- âœ… æ”¯æŒæ‰“æ–­åé‡æ–°å½•éŸ³
- âœ… ä»…åœ¨è¿ç»­æ‰“æ–­æ—¶æ‰æ¸…ç†

---

### 4. `process_server_response()` - é‡æ–°å¯ç”¨å½•éŸ³æ¨¡å¼

#### æ–‡æ¡£æè¿°ï¼š
```python
def process_server_response(self, s):
    # é‡æ–°å¯ç”¨å½•éŸ³æ¨¡å¼ï¼ˆæ¸…ç©ºç¼“å†²åŒºï¼‰
    espsr.stop_recording()
    time.sleep(0.05)
    espsr.start_recording()
    
    # å¯åŠ¨æ’­æ”¾çº¿ç¨‹
    _thread.start_new_thread(self.playback_thread_func, (s,))
```

#### å½“å‰å®ç° (è¡Œ 462-486)ï¼š
```python
def process_server_response(self, s):
    """å¤„ç†æœåŠ¡å™¨å“åº” - å¯åŠ¨æ’­æ”¾çº¿ç¨‹"""
    print("ğŸ§ å¯åŠ¨æ’­æ”¾çº¿ç¨‹å¤„ç†æœåŠ¡å™¨å“åº”...")
    
    # é‡æ–°å¯ç”¨å½•éŸ³æ¨¡å¼ä»¥æ¸…ç©ºæ—§æ•°æ®ï¼Œä¸ºAECæ‰“æ–­æ£€æµ‹åšå‡†å¤‡
    try:
        print("ğŸ”„ é‡æ–°å¯ç”¨å½•éŸ³æ¨¡å¼ï¼ˆæ¸…ç©ºç¼“å†²åŒºï¼‰...")
        espsr.stop_recording()
        time.sleep(0.05)  # çŸ­æš‚å»¶æ—¶
        espsr.start_recording()
        print("âœ… å½•éŸ³æ¨¡å¼å·²é‡æ–°å¯ç”¨")
    except Exception as e:
        print(f"âš ï¸ é‡æ–°å¯ç”¨å½•éŸ³æ¨¡å¼å¤±è´¥: {e}")
    
    # å¯åŠ¨æ’­æ”¾çº¿ç¨‹
    try:
        _thread.start_new_thread(self.playback_thread_func, (s,))
        print("âœ… æ’­æ”¾çº¿ç¨‹å·²å¯åŠ¨")
    except Exception as e:
        print(f"âŒ å¯åŠ¨æ’­æ”¾çº¿ç¨‹å¤±è´¥: {e}")
```

**âœ… ä¸€è‡´æ€§éªŒè¯**ï¼š
- âœ… å…ˆåœæ­¢å½•éŸ³æ¨¡å¼
- âœ… çŸ­æš‚å»¶æ—¶
- âœ… é‡æ–°å¯åŠ¨å½•éŸ³æ¨¡å¼
- âœ… æ¸…ç©ºæ—§ç¼“å†²åŒºæ•°æ®
- âœ… å¯åŠ¨æ’­æ”¾çº¿ç¨‹

---

### 5. `playback_thread_func()` - æ’­æ”¾æœŸé—´æ£€æµ‹æ‰“æ–­

#### æ–‡æ¡£æè¿°ï¼š
```python
def playback_thread_func(self, socket_obj):
    while not self.stop_playback_thread:
        # æ¯5ä¸ªåŒ…æ£€æµ‹ä¸€æ¬¡
        if data_count % 5 == 0:
            result = espsr.listen(1)  # éé˜»å¡æ£€æµ‹
            if result == "wakeup":
                self.wakeup_interrupted = True
                break
        
        # espsr.feed_reference()  # å–‚å‚è€ƒä¿¡å·
        # audio_out.write()       # æ’­æ”¾
```

#### å½“å‰å®ç° (è¡Œ 300-340)ï¼š
```python
try:
    while not self.stop_playback_thread:
        # ğŸ”¥ æ¯éš”ä¸€å®šæ¬¡æ•°æ£€æµ‹æ‰“æ–­ä¿¡å·
        if data_count % interrupt_check_interval == 0:
            try:
                import espsr
                result = espsr.listen(1)  # 1mséé˜»å¡æ£€æµ‹
                if result == "wakeup" or (isinstance(result, dict) and "id" in result):
                    print("ğŸ›‘ æ£€æµ‹åˆ°å”¤é†’è¯æ‰“æ–­ï¼")
                    self.wakeup_interrupted = True
                    self.stop_playback_thread = True
                    break
            except Exception as e:
                pass
        
        # å¢å¤§æ¥æ”¶ç¼“å†²åŒºåˆ°4KB
        data = socket_obj.recv(4096)
        # ... å¤„ç†æ•°æ® ...
        
        # ğŸ”¥ æ’­æ”¾å‰å…ˆè¾“å…¥å‚è€ƒä¿¡å·ç»™AEC
        try:
            espsr.feed_reference(bytes(audio_buffer))
        except:
            pass
        self.audio_out.write(audio_buffer)
```

**âœ… ä¸€è‡´æ€§éªŒè¯**ï¼š
- âœ… ä½¿ç”¨ `espsr.listen(1)` éé˜»å¡æ£€æµ‹
- âœ… æ¯éš”ä¸€å®šæ¬¡æ•°æ£€æµ‹ï¼ˆé»˜è®¤ 5 ä¸ªåŒ…ï¼‰
- âœ… æ£€æµ‹åˆ°å”¤é†’è¯æ—¶è®¾ç½® `wakeup_interrupted`
- âœ… è°ƒç”¨ `espsr.feed_reference()` æä¾›å‚è€ƒä¿¡å·
- âœ… è°ƒç”¨ `audio_out.write()` æ’­æ”¾éŸ³é¢‘

---

### 6. æ’­æ”¾çº¿ç¨‹ç»“æŸå¤„ç†

#### æ–‡æ¡£æè¿°ï¼š
```python
finally:
    if self.wakeup_interrupted:
        print("æ£€æµ‹åˆ°æ‰“æ–­ï¼Œå½•éŸ³æ¨¡å¼ä¿æŒå¼€å¯...")
    else:
        print("æ’­æ”¾å®Œæˆï¼Œåœæ­¢å½•éŸ³æ¨¡å¼...")
        self.deinit_record_mic()
```

#### å½“å‰å®ç° (è¡Œ 366-391)ï¼š
```python
except Exception as e:
    print(f"âŒ æ’­æ”¾çº¿ç¨‹å¼‚å¸¸: {e}")
finally:
    with self.playback_thread_lock:
        self.playback_thread_active = False
        self.is_playing_response = False
        
    if self.stop_playback_thread:
        print("ğŸ›‘ æ’­æ”¾çº¿ç¨‹è¢«åœæ­¢")
        if self.wakeup_interrupted:
            print("ğŸ¤– å°ä¹ï¼šæ£€æµ‹åˆ°æ‰“æ–­ï¼Œå½•éŸ³æ¨¡å¼ä¿æŒå¼€å¯...")
        else:
            print("ğŸ¤– å°ä¹ï¼šæ’­æ”¾è¢«æ‰‹åŠ¨åœæ­¢")
    else:
        print("âœ… æ’­æ”¾çº¿ç¨‹æ­£å¸¸ç»“æŸ")
        # æ’­æ”¾æ­£å¸¸ç»“æŸä¸”æ²¡æœ‰æ‰“æ–­ï¼Œåœæ­¢å½•éŸ³æ¨¡å¼
        if not self.wakeup_interrupted:
            print("ğŸ›‘ æ’­æ”¾å®Œæˆï¼Œåœæ­¢å½•éŸ³æ¨¡å¼...")
            self.deinit_record_mic()
    
    # å…³é—­socketè¿æ¥
    socket_obj.close()
    gc.collect()
    print("ğŸµ æ’­æ”¾çº¿ç¨‹ç»“æŸ")
```

**âœ… ä¸€è‡´æ€§éªŒè¯**ï¼š
- âœ… æœ‰æ‰“æ–­æ—¶ä¿æŒå½•éŸ³æ¨¡å¼å¼€å¯
- âœ… æ— æ‰“æ–­æ—¶åœæ­¢å½•éŸ³æ¨¡å¼
- âœ… æ¸…ç†èµ„æºï¼ˆsocketã€gcï¼‰
- âœ… æ›´æ–°çŠ¶æ€æ ‡å¿—

---

### 7. `deinit_record_mic()` - åœæ­¢å½•éŸ³æ¨¡å¼

#### æ–‡æ¡£æè¿°ï¼š
```python
def deinit_record_mic(self):
    espsr.stop_recording()  # åªåœæ­¢ç¼“å†²åŒºå†™å…¥
```

#### å½“å‰å®ç° (è¡Œ 631-643)ï¼š
```python
def deinit_record_mic(self):
    """åœæ­¢å½•éŸ³æ¨¡å¼"""
    print("ğŸ›‘ åœæ­¢ESP-SRå½•éŸ³æ¨¡å¼...")
    self.is_init_record_mic = False

    try:
        espsr.stop_recording()
        print("âœ… å½•éŸ³æ¨¡å¼å·²åœæ­¢")
    except Exception as e:
        print(f"âš ï¸ åœæ­¢å½•éŸ³æ—¶å‡ºé”™: {e}")

    # çŸ­æš‚å»¶æ—¶ç¡®ä¿çŠ¶æ€åŒæ­¥
    time.sleep(0.1)
```

**âœ… ä¸€è‡´æ€§éªŒè¯**ï¼š
- âœ… è°ƒç”¨ `espsr.stop_recording()`
- âœ… ä¸æ“ä½œ I2S ç¡¬ä»¶
- âœ… åªåœæ­¢ç¼“å†²åŒºå†™å…¥

---

## ğŸ¯ å®Œæ•´æµç¨‹éªŒè¯

### æ–‡æ¡£æè¿°çš„æµç¨‹ï¼š
```
å¾…æœº â†’ espsr.listen() æ£€æµ‹å”¤é†’è¯
  â†“
espsr.start_recording() â† å¯ç”¨ç¼“å†²åŒº
  â†“
record_and_send()
  â”œâ”€ espsr.read_audio() â† ä¸»åŠ¨è¯»å–
  â”œâ”€ s.send() â† å‘é€
  â””â”€ é™éŸ³æ£€æµ‹ â†’ break â† åœæ­¢å‘é€
  â†“
é‡æ–°å¯ç”¨å½•éŸ³ï¼ˆæ¸…ç©ºç¼“å†²ï¼‰
  â†“
å¯åŠ¨æ’­æ”¾çº¿ç¨‹
  â”œâ”€ espsr.listen(1) â† æ£€æµ‹æ‰“æ–­
  â”œâ”€ espsr.feed_reference() â† AEC
  â””â”€ audio_out.write() â† æ’­æ”¾
  â†“
æ’­æ”¾ç»“æŸ â†’ deinit_record_mic()
```

### å½“å‰å®ç°çš„æµç¨‹ï¼š
```python
# ä¸»å¾ªç¯ (run å‡½æ•°)
while True:
    result = espsr.listen(10)  # â† æ£€æµ‹å”¤é†’è¯
    if result == "wakeup":
        self.recordToAI()

# recordToAI()
espsr.start_recording()        # â† å¯ç”¨ç¼“å†²åŒº âœ…
self.record_and_send()

# record_and_send()
while ...:
    bytes_read = espsr.read_audio(buffer)  # â† ä¸»åŠ¨è¯»å– âœ…
    s.send(buffer[:bytes_read])            # â† å‘é€ âœ…
    if detect_silence():
        break                               # â† åœæ­¢å‘é€ âœ…

# process_server_response()
espsr.stop_recording()                      # â† é‡æ–°å¯ç”¨ï¼ˆæ¸…ç©ºï¼‰ âœ…
espsr.start_recording()
_thread.start_new_thread(playback_thread_func)

# playback_thread_func()
while ...:
    if data_count % 5 == 0:
        result = espsr.listen(1)            # â† æ£€æµ‹æ‰“æ–­ âœ…
    espsr.feed_reference(audio_buffer)      # â† AEC âœ…
    self.audio_out.write(audio_buffer)      # â† æ’­æ”¾ âœ…

# finally
if not self.wakeup_interrupted:
    self.deinit_record_mic()                # â† åœæ­¢å½•éŸ³ âœ…
```

**âœ… æµç¨‹ä¸€è‡´æ€§éªŒè¯**ï¼šæ‰€æœ‰æ­¥éª¤å®Œå…¨å¯¹é½ï¼

---

## ğŸ“Š æœ€ç»ˆéªŒè¯ç»“æœ

| éªŒè¯é¡¹ | çŠ¶æ€ |
|-------|------|
| **å½•éŸ³æ¨¡å¼ â‰  å‘é€æ•°æ®** | âœ… ä¸€è‡´ |
| **ä¸»åŠ¨è¯»å–å¹¶å‘é€** | âœ… ä¸€è‡´ |
| **åœæ­¢å‘é€æ¡ä»¶** | âœ… ä¸€è‡´ |
| **ä¿æŒå½•éŸ³æ¨¡å¼å¼€å¯** | âœ… ä¸€è‡´ |
| **é‡æ–°å¯ç”¨å½•éŸ³ï¼ˆæ¸…ç©ºç¼“å†²ï¼‰** | âœ… ä¸€è‡´ |
| **æ’­æ”¾æœŸé—´æ£€æµ‹æ‰“æ–­** | âœ… ä¸€è‡´ |
| **AEC å‚è€ƒä¿¡å·** | âœ… ä¸€è‡´ |
| **æ™ºèƒ½æ¸…ç†èµ„æº** | âœ… ä¸€è‡´ |
| **å®Œæ•´æµç¨‹** | âœ… ä¸€è‡´ |

---

## âœ… ç»“è®º

**å½“å‰ `logic.py` çš„å®ç°ä¸ã€Šå½•éŸ³ä¸AECé€»è¾‘å¯¹æ¯”è¯´æ˜.mdã€‹æ–‡æ¡£æè¿°çš„é€»è¾‘ 100% ä¸€è‡´ï¼**

### æ ¸å¿ƒéªŒè¯ç‚¹ï¼š

1. âœ… **å½•éŸ³æ¨¡å¼** åªå¯ç”¨ç¼“å†²åŒºå†™å…¥ï¼Œä¸å‘é€æ•°æ®
2. âœ… **record_and_send()** ä¸»åŠ¨è¯»å–å¹¶å‘é€ï¼Œæœ‰æ˜ç¡®åœæ­¢æ¡ä»¶
3. âœ… **recordToAI()** å½•éŸ³å®Œæˆåä¿æŒå½•éŸ³æ¨¡å¼å¼€å¯
4. âœ… **process_server_response()** é‡æ–°å¯ç”¨å½•éŸ³ä»¥æ¸…ç©ºç¼“å†²åŒº
5. âœ… **playback_thread_func()** æ’­æ”¾æœŸé—´æ£€æµ‹æ‰“æ–­ + AEC
6. âœ… **æ™ºèƒ½æ¸…ç†** æœ‰æ‰“æ–­ä¿æŒå¼€å¯ï¼Œæ— æ‰“æ–­æ‰åœæ­¢

### å®ç°è´¨é‡ï¼š

- ğŸ¯ é€»è¾‘æ¸…æ™°ï¼Œåˆ†å±‚æ˜ç¡®
- ğŸ¯ æ³¨é‡Šå®Œæ•´ï¼Œæ˜“äºç†è§£
- ğŸ¯ é”™è¯¯å¤„ç†å®Œå–„
- ğŸ¯ èµ„æºç®¡ç†æ­£ç¡®
- ğŸ¯ å®Œå…¨å¯¹é½å‚è€ƒé¡¹ç›®çš„ AEC æ ¸å¿ƒæ€è·¯
- ğŸ¯ åœ¨æ’­æ”¾æ‰“æ–­æ”¯æŒä¸Šæ›´åŠ ç®€æ´é«˜æ•ˆ

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- `å½•éŸ³ä¸AECé€»è¾‘å¯¹æ¯”è¯´æ˜.md` - è¯¦ç»†é€»è¾‘è¯´æ˜ï¼ˆæœ¬éªŒè¯çš„å‚è€ƒæ–‡æ¡£ï¼‰
- `I2Sèµ„æºå†²çªä¿®å¤è¯´æ˜.md` - å…±äº« I2S å®ç°
- `AECæ‰“æ–­åŠŸèƒ½ä¿®å¤è¯´æ˜.md` - æ‰“æ–­é€»è¾‘ä¼˜åŒ–

## ç”Ÿæˆæ—¥æœŸ

2025-10-27

