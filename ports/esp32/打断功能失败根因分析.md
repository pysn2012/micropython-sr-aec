# æ‰“æ–­åŠŸèƒ½å¤±è´¥æ ¹å› åˆ†æä¸è§£å†³æ–¹æ¡ˆ

## ğŸ” é—®é¢˜ç°è±¡

ç”¨æˆ·åé¦ˆï¼š**æ’­æ”¾å›å¤éŸ³é¢‘æœŸé—´ï¼Œå¤§å£°å”¤é†’ä¹Ÿæ— æ³•æ‰“æ–­æ’­æ”¾ã€‚**

---

## âœ… å·²éªŒè¯æ­£ç¡®çš„éƒ¨åˆ†

### 1. feed_Task æŒç»­è¿è¡Œ âœ…

```c
void feed_Task(void *arg) {
    while (task_flag) {  // â† æŒç»­å¾ªç¯
        // ä» I2S è¯»å–éº¦å…‹é£æ•°æ®
        i2s_channel_read(rx_handle, mic_data, ...);
        
        // æ„å»ºåŒé€šé“æ•°æ® (Mic + Reference)
        feed_buff[i * 2] = mic_data[i];
        feed_buff[i * 2 + 1] = reference[i];
        
        // å–‚ç»™ AFE
        afe_handle->feed(afe_data, feed_buff);  // â† æŒç»­ Feed
    }
}
```

**éªŒè¯**ï¼šâœ… éŸ³é¢‘æ•°æ®æŒç»­å–‚ç»™ AFEï¼Œæ— è®ºä»€ä¹ˆçŠ¶æ€

### 2. detect_Task æŒç»­è¿è¡Œ âœ…

```c
void detect_Task(void *arg) {
    while (task_flag) {  // â† æŒç»­å¾ªç¯
        // ä» AFE è·å–å¤„ç†åçš„æ•°æ®
        res = afe_handle->fetch(afe_data);
        
        // MultiNet æ£€æµ‹
        mn_state = multinet->detect(model_data, res->data);  // â† æŒç»­æ£€æµ‹
        
        if (mn_state == ESP_MN_STATE_DETECTED) {
            // æ£€æµ‹åˆ°å”¤é†’è¯/å‘½ä»¤è¯
            xQueueSend(g_result_que, &result, 10);  // â† å‘é€ç»“æœ
        }
    }
}
```

**éªŒè¯**ï¼šâœ… æ£€æµ‹æŒç»­è¿è¡Œï¼Œæ— è®ºä»€ä¹ˆçŠ¶æ€

### 3. AEC å‚è€ƒä¿¡å·å·²æ­£ç¡®å–‚å…¥ âœ…

```python
# logic.py - playback_thread_func
espsr.feed_reference(bytes(audio_buffer))  # â† æ’­æ”¾å‰å–‚å‚è€ƒä¿¡å·
self.audio_out.write(audio_buffer)
```

**éªŒè¯**ï¼šâœ… å‚è€ƒä¿¡å·æ­£ç¡®ä¼ é€’ç»™ AEC

---

## âŒ æ ¹æœ¬é—®é¢˜ï¼šç»“æœé˜Ÿåˆ—æœºåˆ¶ç¼ºé™·

### é—®é¢˜ 1: é˜Ÿåˆ—å¤§å°åªæœ‰ 1

```c
// modespsr.c - espsr_init()
g_result_que = xQueueCreate(1, sizeof(sr_result_t));  // â† é˜Ÿåˆ—å¤§å° = 1
```

**å½±å“**ï¼š
- é˜Ÿåˆ—åªèƒ½å­˜å‚¨ **1 ä¸ªæ£€æµ‹ç»“æœ**
- å¦‚æœä¸Šä¸€ä¸ªç»“æœæœªè¢«è¯»å–ï¼Œæ–°ç»“æœä¼šè¢« **ä¸¢å¼ƒ** æˆ– **è¦†ç›–**

### é—®é¢˜ 2: Python å±‚è¯»å–é¢‘ç‡è¿‡ä½

```python
# logic.py - playback_thread_func
while not self.stop_playback_thread:
    # æ¯ 5 ä¸ªåŒ…æ‰æ£€æµ‹ä¸€æ¬¡
    if data_count % interrupt_check_interval == 0:  # interrupt_check_interval = 5
        result = espsr.listen(1)  # â† è¯»å–ç»“æœ
```

**è®¡ç®—å®é™…è¯»å–é—´éš”**ï¼š
- æ¯ä¸ªåŒ… 4096 å­—èŠ‚ = 2048 æ ·æœ¬ (16ä½)
- é‡‡æ ·ç‡ 16000 Hz â†’ 2048/16000 = 0.128 ç§’/åŒ…
- æ¯ 5 ä¸ªåŒ…æ£€æµ‹ä¸€æ¬¡ â†’ **0.64 ç§’æ‰è¯»å–ä¸€æ¬¡ç»“æœ** âŒ

### é—®é¢˜ 3: xQueueSend çš„è¡Œä¸º

```c
xQueueSend(g_result_que, &result, 10);  // ç­‰å¾… 10 ticks (çº¦ 10ms)
```

**é˜Ÿåˆ—å·²æ»¡æ—¶çš„è¡Œä¸º**ï¼š
1. å°è¯•å‘é€ç»“æœ
2. é˜Ÿåˆ—æ»¡ï¼Œç­‰å¾…æœ€å¤š 10ms
3. 10ms åä»ç„¶æ»¡ â†’ **å‘é€å¤±è´¥ï¼Œç»“æœä¸¢å¼ƒ** âŒ

---

## ğŸ¯ è¯¦ç»†æ—¶é—´çº¿åˆ†æ

### æ­£å¸¸æƒ…å†µï¼ˆç†æƒ³ï¼‰

```
t=0.0s: æ’­æ”¾å¼€å§‹ï¼Œå¯åŠ¨æ£€æµ‹
t=0.1s: ç”¨æˆ·è¯´"å—¨å°ä¹"
t=0.15s: detect_Task æ£€æµ‹åˆ°å”¤é†’è¯
t=0.15s: xQueueSend â†’ æˆåŠŸæ”¾å…¥é˜Ÿåˆ—
t=0.15s: Python è°ƒç”¨ espsr.listen() â†’ è¯»å–ç»“æœ
t=0.15s: æ‰“æ–­æ’­æ”¾ âœ…
```

### å®é™…æƒ…å†µï¼ˆå¤±è´¥ï¼‰

```
t=0.0s: æ’­æ”¾å¼€å§‹
  â”œâ”€ data_count = 0
  â””â”€ è°ƒç”¨ espsr.listen(1) â†’ è¯»å–é˜Ÿåˆ—ï¼ˆç©ºï¼‰

t=0.13s: æ¥æ”¶åŒ… #1
t=0.26s: æ¥æ”¶åŒ… #2
t=0.39s: æ¥æ”¶åŒ… #3
t=0.52s: æ¥æ”¶åŒ… #4

--- ç”¨æˆ·åœ¨è¿™æœŸé—´è¯´"å—¨å°ä¹" ---
t=0.55s: detect_Task æ£€æµ‹åˆ°å”¤é†’è¯
  â””â”€ xQueueSend(g_result_que, &result, 10)
  â””â”€ ç»“æœè¿›å…¥é˜Ÿåˆ—ï¼ˆé˜Ÿåˆ—å¤§å° 1/1ï¼‰

t=0.65s: æ¥æ”¶åŒ… #5
  â””â”€ data_count % 5 == 0
  â””â”€ è°ƒç”¨ espsr.listen(1)
  â””â”€ **åº”è¯¥è¯»åˆ°ç»“æœ** âœ…

--- ä½†å¦‚æœåœ¨ 0.55s å’Œ 0.65s ä¹‹é—´æœ‰ç¬¬äºŒæ¬¡æ£€æµ‹ ---
t=0.60s: detect_Task å†æ¬¡æ£€æµ‹åˆ°ï¼ˆè¯­éŸ³å°¾éƒ¨ï¼‰
  â””â”€ xQueueSend() å°è¯•å‘é€
  â””â”€ é˜Ÿåˆ—å·²æ»¡ï¼ˆç¬¬ä¸€ä¸ªç»“æœè¿˜æœªè¯»å–ï¼‰
  â””â”€ ç­‰å¾… 10ms
  â””â”€ **å‘é€å¤±è´¥ï¼Œç»“æœä¸¢å¼ƒ** âŒ

t=0.65s: è°ƒç”¨ espsr.listen(1)
  â””â”€ è¯»åˆ°ç¬¬ä¸€ä¸ªç»“æœï¼ˆ0.55s çš„ï¼‰
  â””â”€ æ‰“æ–­æ’­æ”¾ âœ…

--- æˆ–è€…æ›´ç³Ÿçš„æƒ…å†µ ---
t=0.64s: å¦ä¸€ä¸ªä»»åŠ¡è°ƒç”¨ espsr.listen()
  â””â”€ è¯»å–äº† 0.55s çš„ç»“æœ
  â””â”€ é˜Ÿåˆ—å˜ç©º

t=0.65s: æ’­æ”¾çº¿ç¨‹è°ƒç”¨ espsr.listen(1)
  â””â”€ é˜Ÿåˆ—å·²ç©º
  â””â”€ **è¶…æ—¶ï¼Œæ— æ³•æ‰“æ–­** âŒ
```

---

## ğŸ” ä¸å‚è€ƒé¡¹ç›®çš„å¯¹æ¯”

### å‚è€ƒé¡¹ç›®

```cpp
// AudioLoop æ¯æ¬¡éƒ½å¤„ç†
void Application::OnAudioInput() {
    if (wake_word_detect_.IsDetectionRunning()) {
        ReadAudio(data);
        wake_word_detect_.Feed(data);  // â† æ¯æ¬¡å¾ªç¯éƒ½ Feed
    }
}

// æ£€æµ‹åˆ°å”¤é†’è¯æ—¶ç«‹å³å›è°ƒ
wake_word_detect_.OnWakeWordDetected([](wake_word) {
    if (device_state_ == Speaking) {
        AbortSpeaking();  // â† ç«‹å³æ‰“æ–­
    }
});
```

**å…³é”®å·®å¼‚**ï¼š
- å‚è€ƒé¡¹ç›®ä½¿ç”¨ **å›è°ƒæœºåˆ¶**ï¼Œæ£€æµ‹åˆ°ç«‹å³å¤„ç†
- å½“å‰å®ç°ä½¿ç”¨ **é˜Ÿåˆ—æœºåˆ¶** + **è½®è¯¢è¯»å–**ï¼Œæœ‰å»¶è¿Ÿ

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: å¢å¤§ç»“æœé˜Ÿåˆ—ï¼ˆç®€å•æœ‰æ•ˆï¼‰

```c
// modespsr.c
g_result_que = xQueueCreate(10, sizeof(sr_result_t));  // æ”¹ä¸º 10
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ”¹åŠ¨æœ€å°
- âœ… å¯ä»¥ç¼“å­˜å¤šä¸ªæ£€æµ‹ç»“æœ
- âœ… é™ä½ç»“æœä¸¢å¤±æ¦‚ç‡

**ç¼ºç‚¹**ï¼š
- âš ï¸ ä»ç„¶ä¾èµ–è½®è¯¢è¯»å–
- âš ï¸ é«˜é¢‘æ£€æµ‹æ—¶ä»å¯èƒ½æº¢å‡º

### æ–¹æ¡ˆ 2: æ›´é¢‘ç¹åœ°è¯»å–ç»“æœï¼ˆé…åˆæ–¹æ¡ˆ1ï¼‰

```python
# logic.py - playback_thread_func
interrupt_check_interval = 1  # æ”¹ä¸ºæ¯ä¸ªåŒ…éƒ½æ£€æµ‹ï¼ˆåŸæ¥æ˜¯ 5ï¼‰
```

**è®¡ç®—**ï¼š
- æ¯ä¸ªåŒ… 0.128 ç§’
- æ¯åŒ…éƒ½æ£€æµ‹ â†’ **0.128 ç§’è¯»å–ä¸€æ¬¡** âœ…

**ä¼˜ç‚¹**ï¼š
- âœ… å¤§å¹…é™ä½å»¶è¿Ÿ
- âœ… æ£€æµ‹æ›´åŠæ—¶

**ç¼ºç‚¹**ï¼š
- âš ï¸ ç¨å¾®å¢åŠ  CPU å¼€é”€ï¼ˆä½†å¯æ¥å—ï¼‰

### æ–¹æ¡ˆ 3: ä½¿ç”¨è¦†ç›–æ¨¡å¼é˜Ÿåˆ—ï¼ˆæœ€ä¼˜é›…ï¼‰

```c
// modespsr.c
g_result_que = xQueueCreate(1, sizeof(sr_result_t));

// detect_Task ä¸­
xQueueOverwrite(g_result_que, &result);  // æ€»æ˜¯è¦†ç›–æœ€æ–°ç»“æœ
```

**ä¼˜ç‚¹**ï¼š
- âœ… å§‹ç»ˆä¿å­˜æœ€æ–°çš„æ£€æµ‹ç»“æœ
- âœ… ä¸ä¼šå› é˜Ÿåˆ—æ»¡è€Œä¸¢å¤±
- âœ… é˜Ÿåˆ—å¤§å°ä»ä¸º 1ï¼ŒèŠ‚çœå†…å­˜

**ç¼ºç‚¹**ï¼š
- âš ï¸ å¯èƒ½ä¸¢å¤±ä¸­é—´çš„æ£€æµ‹ï¼ˆä½†æ‰“æ–­åªéœ€æœ€æ–°çš„ï¼‰

### æ–¹æ¡ˆ 4: å›è°ƒæœºåˆ¶ï¼ˆæœ€å½»åº•ï¼Œä½†å¤æ‚ï¼‰

ç±»ä¼¼å‚è€ƒé¡¹ç›®ï¼Œä½¿ç”¨å›è°ƒè€Œéé˜Ÿåˆ—ï¼š

```c
// modespsr.c
static mp_obj_t g_wakeup_callback = MP_OBJ_NULL;

void detect_Task() {
    if (mn_state == ESP_MN_STATE_DETECTED) {
        if (g_wakeup_callback != MP_OBJ_NULL) {
            mp_sched_schedule(g_wakeup_callback, result);  // è°ƒåº¦å›è°ƒ
        }
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ£€æµ‹åˆ°ç«‹å³å¤„ç†
- âœ… æ— å»¶è¿Ÿ
- âœ… ä¸ä¾èµ–è½®è¯¢

**ç¼ºç‚¹**ï¼š
- âŒ å®ç°å¤æ‚
- âŒ MicroPython çš„å›è°ƒè°ƒåº¦æœ‰é™åˆ¶

---

## ğŸ“‹ æ¨èæ–¹æ¡ˆï¼ˆç»„åˆï¼‰

### ç«‹å³å®æ–½ï¼ˆæœ€å°æ”¹åŠ¨ï¼‰

**1. å¢å¤§é˜Ÿåˆ—**

```c
// modespsr.c - espsr_init()
g_result_que = xQueueCreate(10, sizeof(sr_result_t));  // 1 â†’ 10
```

**2. æ›´é¢‘ç¹æ£€æµ‹**

```python
# logic.py - playback_thread_func
interrupt_check_interval = 1  // 5 â†’ 1
```

### è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

**3. ä½¿ç”¨è¦†ç›–æ¨¡å¼**

```c
// modespsr.c - detect_Task()
xQueueOverwrite(g_result_que, &result);  // æ›¿ä»£ xQueueSend
```

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### ä¿®æ”¹å‰

```
æ£€æµ‹é—´éš”: 0.64 ç§’
é˜Ÿåˆ—å¤§å°: 1
ä¸¢å¤±æ¦‚ç‡: é«˜
å“åº”å»¶è¿Ÿ: 0.1~0.64 ç§’
```

### ä¿®æ”¹åï¼ˆæ–¹æ¡ˆ 1+2ï¼‰

```
æ£€æµ‹é—´éš”: 0.128 ç§’
é˜Ÿåˆ—å¤§å°: 10
ä¸¢å¤±æ¦‚ç‡: æä½
å“åº”å»¶è¿Ÿ: 0~0.128 ç§’
```

### ä¿®æ”¹åï¼ˆæ–¹æ¡ˆ 1+2+3ï¼‰

```
æ£€æµ‹é—´éš”: 0.128 ç§’
é˜Ÿåˆ—æ¨¡å¼: è¦†ç›–
ä¸¢å¤±æ¦‚ç‡: æ— 
å“åº”å»¶è¿Ÿ: 0~0.128 ç§’
```

---

## ğŸ”§ å…·ä½“ä¿®æ”¹ä»£ç 

### modespsr.c

```c
// ä¿®æ”¹ 1: å¢å¤§é˜Ÿåˆ—
static mp_obj_t espsr_init(void) {
    // ...
    
    // åˆ›å»ºç»“æœé˜Ÿåˆ— - ä» 1 æ”¹ä¸º 10
    g_result_que = xQueueCreate(10, sizeof(sr_result_t));
    
    // ...
}

// ä¿®æ”¹ 2: ä½¿ç”¨è¦†ç›–æ¨¡å¼ï¼ˆå¯é€‰ï¼‰
void detect_Task(void *arg) {
    // ...
    
    if (ESP_MN_STATE_DETECTED == mn_state) {
        // ...
        
        // æ–¹å¼A: åŸæ¥çš„æ–¹å¼ï¼ˆé…åˆå¤§é˜Ÿåˆ—ï¼‰
        xQueueSend(g_result_que, &result, 10);
        
        // æ–¹å¼B: è¦†ç›–æ¨¡å¼ï¼ˆæ¨èï¼‰
        // xQueueOverwrite(g_result_que, &result);
        
        send_pulse();
    }
}
```

### logic.py

```python
def playback_thread_func(self, socket_obj):
    # ...
    MIN_PLAY_BUFFER = 4096
    interrupt_check_interval = 1  # æ”¹ä¸º 1ï¼ˆåŸæ¥æ˜¯ 5ï¼‰
    
    try:
        while not self.stop_playback_thread:
            # æ¯ä¸ªåŒ…éƒ½æ£€æµ‹æ‰“æ–­
            if data_count % interrupt_check_interval == 0:
                try:
                    result = espsr.listen(1)  # 1ms éé˜»å¡
                    if result == "wakeup" or (isinstance(result, dict) and "id" in result):
                        print("ğŸ›‘ æ£€æµ‹åˆ°å”¤é†’è¯æ‰“æ–­ï¼")
                        self.wakeup_interrupted = True
                        self.stop_playback_thread = True
                        break
                except Exception as e:
                    pass
```

---

## ğŸ“Š æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **ç¼–è¯‘å¹¶çƒ§å½•å›ºä»¶**
   ```bash
   cd ports/esp32
   idf.py build
   idf.py flash
   idf.py monitor
   ```

2. **æµ‹è¯•æ‰“æ–­**
   - è¯´"å—¨å°ä¹"å”¤é†’
   - ç­‰å¾…æ’­æ”¾å›å¤
   - åœ¨æ’­æ”¾æœŸé—´å†æ¬¡è¯´"å—¨å°ä¹"
   - è§‚å¯Ÿæ˜¯å¦ç«‹å³åœæ­¢æ’­æ”¾

3. **è§‚å¯Ÿæ—¥å¿—**
   ```
   [æœŸæœ›çœ‹åˆ°]
   ğŸ”Š æ’­æ”¾éŸ³é¢‘å—: 2048 å­—èŠ‚
   ğŸ”Š æ’­æ”¾éŸ³é¢‘å—: 2048 å­—èŠ‚
   ğŸ›‘ æ£€æµ‹åˆ°å”¤é†’è¯æ‰“æ–­ï¼  â† åº”è¯¥å‡ºç°
   ğŸ¤– å°ä¹ï¼šæ£€æµ‹åˆ°æ‰“æ–­ï¼Œå½•éŸ³æ¨¡å¼ä¿æŒå¼€å¯...
   ğŸ”„ æ£€æµ‹åˆ°æ‰“æ–­ï¼Œå‡†å¤‡é‡æ–°å½•éŸ³
   ```

---

## ğŸ“Œ æ€»ç»“

### æ ¹æœ¬åŸå› 

1. âŒ ç»“æœé˜Ÿåˆ—å¤ªå°ï¼ˆåªæœ‰ 1ï¼‰
2. âŒ è¯»å–é¢‘ç‡å¤ªä½ï¼ˆæ¯ 0.64 ç§’ï¼‰
3. âŒ é˜Ÿåˆ—æ»¡æ—¶ç»“æœè¢«ä¸¢å¼ƒ

### è§£å†³æ–¹æ³•

1. âœ… å¢å¤§é˜Ÿåˆ—åˆ° 10
2. âœ… æé«˜è¯»å–é¢‘ç‡ï¼ˆæ¯ 0.128 ç§’ï¼‰
3. âœ… (å¯é€‰) ä½¿ç”¨è¦†ç›–æ¨¡å¼

### ä¸ºä»€ä¹ˆä¹‹å‰ä»¥ä¸ºæ˜¯æ­£ç¡®çš„ï¼Ÿ

- feed_Task å’Œ detect_Task **ç¡®å®æŒç»­è¿è¡Œ** âœ…
- AEC å‚è€ƒä¿¡å·**ç¡®å®æ­£ç¡®å–‚å…¥** âœ…
- æ£€æµ‹å™¨**ç¡®å®åœ¨æ£€æµ‹** âœ…

ä½†æ˜¯ï¼š
- æ£€æµ‹ç»“æœ**æœªèƒ½åŠæ—¶ä¼ é€’**åˆ° Python å±‚ âŒ
- é˜Ÿåˆ—æœºåˆ¶æˆä¸ºç“¶é¢ˆ âŒ

---

## æ›´æ–°æ—¥æœŸ

2025-10-27

