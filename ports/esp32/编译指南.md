# AEC打断功能 - 编译和部署指南

## ✅ 代码改动已全部完成

- ✅ `modespsr.c` - 9处改动完成
- ✅ `logic.py` - 4处改动完成
- ✅ 语法检查通过，无错误

---

## 🔨 编译步骤

### 1. 进入编译目录
```bash
cd /Users/renzhaojing/gitcode/renhejia/micropython-sr-aec/ports/esp32
```

### 2. 清理之前的编译
```bash
make clean
```

### 3. 编译固件（使用多核加速）
```bash
make -j8
```

**预期输出**：
```
CC build-ESP32_GENERIC_S3/frozen_content.c
...
LINK build-ESP32_GENERIC_S3/micropython.elf
Create build-ESP32_GENERIC_S3/micropython.bin
esptool.py v4.x
...
```

### 4. 烧录固件
```bash
# 首次烧录建议先擦除
make erase

# 烧录固件
make deploy
```

**或者分步执行**：
```bash
# 擦除flash
python -m esptool --port /dev/cu.usbmodem* erase_flash

# 烧录
python -m esptool --port /dev/cu.usbmodem* write_flash -z 0x0 build-ESP32_GENERIC_S3/firmware.bin
```

---

## 📤 上传Python文件

### 使用Thonny IDE

1. 打开Thonny
2. 连接设备（选择正确的串口）
3. 打开文件：`ports/esp32/modules/logic.py`
4. 点击"保存"→选择"MicroPython device"
5. 保存为 `/logic.py`（设备根目录）

### 或使用ampy工具

```bash
# 安装ampy
pip install adafruit-ampy

# 上传文件
ampy --port /dev/cu.usbmodem* put ports/esp32/modules/logic.py /logic.py
```

---

## 🧪 验证和测试

### 1. 查看启动日志

连接串口（Thonny或其他终端），查看启动日志：

```python
import logic
sensor = logic.SensorSystem()
sensor.run()
```

**预期日志**：
```
Initializing ESP-SR with AEC...
Reference buffer allocated: 32000 samples
AFE config: format=MR, aec_init=true, aec_mode=1
AFE feed channels: 2 (expected: 2 for MR)
✅ ESP-SR 初始化成功（AEC模式）!
Feed task started: chunksize=512, channels=2
🔍 开始监听（AEC模式）... [唤醒:0 命令:0]
```

### 2. 测试唤醒功能

说"嗨小乐"：

**预期输出**：
```
🎉 检测到唤醒词'嗨小乐'! (第1次)
   🤖 小乐：您好，有什么可以帮您的吗?
play wozai
start recordToAI
```

### 3. 测试打断功能

1. 唤醒后提问
2. 等待播放回复
3. 播放过程中再次说"嗨小乐"

**预期输出**：
```
🎵 播放线程启动（支持AEC打断）
📡 接收 #1, 4096字节
📡 接收 #6, 4096字节
🛑 检测到唤醒词打断！      ← 成功！
🛑 播放线程被停止
🔄 检测到播放被打断，立即开始新的录音...
start recordToAI
```

---

## 🐛 常见问题排查

### 问题1：编译错误
```
error: 'AEC_MODE_SR_HIGH_PERF' undeclared
```

**解决**：检查ESP-SR版本，可能需要使用：
```c
afe_config->aec_mode = AEC_MODE_VOIP_HIGH_PERF;
```

### 问题2：运行时错误
```
Failed to allocate reference buffer
```

**解决**：检查SPIRAM配置
```bash
# 查看sdkconfig中的SPIRAM设置
grep SPIRAM sdkconfig
```

### 问题3：打断不工作

**检查**：
1. 日志是否显示 "AFE feed channels: 2"
2. 是否看到 "feed_reference" 被调用
3. AEC是否启用（aec_init=true）

**调试**：在logic.py中添加日志
```python
# 在feed_reference调用处添加
print(f"📝 输入参考信号: {len(audio_buffer)} 字节")
espsr.feed_reference(bytes(audio_buffer))
```

### 问题4：音质问题

如果发现音质有问题，可以调整AEC模式：
```c
// modespsr.c 第340行
afe_config->aec_mode = AEC_MODE_VOIP_HIGH_PERF;  // 试试VOIP模式
```

---

## 📊 性能监控

### 查看内存使用

```python
import gc
gc.collect()
print("Free memory:", gc.mem_free())
print("Used memory:", gc.mem_alloc())
```

**预期**：
- 初始化后：~200KB PSRAM被使用
- 播放时：额外~64KB（参考缓冲区）

### 查看CPU使用

观察日志输出的频率和响应时间。

---

## ✅ 成功标志

当你看到以下所有输出，说明AEC打断功能工作正常：

- [x] ✅ ESP-SR 初始化成功（AEC模式）
- [x] AFE feed channels: 2
- [x] Reference buffer allocated
- [x] 🎵 播放线程启动（支持AEC打断）
- [x] 🛑 检测到唤醒词打断！
- [x] 🔄 检测到播放被打断

---

## 🎉 完成

恭喜！如果所有测试通过，说明AEC打断功能已经成功实现！

**享受连续对话的体验吧！** 🚀

---

## 📞 需要帮助？

如遇到问题，请检查：
1. 编译日志中的错误信息
2. 运行时日志中的关键输出
3. 参考 `AEC_COMPLETE_IMPLEMENTATION_GUIDE.md` 的详细说明

或者参考：
- `AEC_IMPLEMENTATION_CHECKLIST.md` - 快速检查清单
- `AEC实现方案总结.md` - 原理说明
- `AEC_实施完成总结.md` - 改动总结

